#!/usr/bin/env bash
set -euo pipefail

# installer for xui system
    # Fixes: defines missing helpers, removes duplicated blocks, and ensures a runnable flow

USER_HOME="${HOME:-/home/$(whoami)}"
XUI_DIR="$USER_HOME/.xui"
DATA_DIR="$XUI_DIR/data"
BIN_DIR="$XUI_DIR/bin"
DASH_DIR="$XUI_DIR/dashboard"
CASINO_DIR="$XUI_DIR/casino"
GAMES_DIR="$XUI_DIR/games"
ASSETS_DIR="$XUI_DIR/assets"
LOG_DIR="$XUI_DIR/logs"
BACKUP_DIR="$XUI_DIR/backups"
SYSTEMD_USER_DIR="$USER_HOME/.config/systemd/user"
AUTOSTART_DIR="$USER_HOME/.config/autostart"

info(){ echo -e "[INFO] $*"; }
warn(){ echo -e "[WARN] $*" >&2; }
check_cmd(){ command -v "$1" >/dev/null 2>&1; }

# Try to install python packages in user site if allowed
pip_install(){
    pkg="$1"
    if [ "${AUTO_INSTALL_TOOLS:-0}" -ne 1 ]; then
        return 1
    fi
    # try pip executables first
    if check_cmd pip3; then
        pip3 install --user "$pkg" || return 1
        return 0
    fi
    if check_cmd pip; then
        pip install --user "$pkg" || return 1
        return 0
    fi
    if check_cmd python3; then
        # try to bootstrap pip
        python3 -m ensurepip --upgrade >/dev/null 2>&1 || true
        python3 -m pip install --user "$pkg" >/dev/null 2>&1 || return 1
        return 0
    fi
    return 1
}

parse_args(){
    # Support --yes-install to allow automatic package installs (non-interactive)
    AUTO_INSTALL_TOOLS=0
    XUI_INSTALL_SYSTEM=0
    while [ "$#" -gt 0 ]; do
        case "$1" in
            --yes-install|-y)
                AUTO_INSTALL_TOOLS=1
                XUI_INSTALL_SYSTEM=1
                shift
                ;;
            --help|-h)
                echo "Usage: $0 [--yes-install]"; exit 0 ;;
            *)
                # pass-through unknown args
                shift
                ;;
        esac
    done
    export AUTO_INSTALL_TOOLS XUI_INSTALL_SYSTEM
}

ensure_dirs(){
  mkdir -p "$ASSETS_DIR" "$BIN_DIR" "$DASH_DIR" "$DATA_DIR" "$SYSTEMD_USER_DIR" "$AUTOSTART_DIR" || true
}

copy_assets(){
  # Copy common asset types from installer directory (script dir) into assets
  local script_dir
  script_dir="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
    # First copy explicit common assets if present
    for name in applogo.png bootlogo.png startup.mp3 startup.mp4; do
        if [ -f "$script_dir/$name" ]; then
            cp -f "$script_dir/$name" "$ASSETS_DIR/" && info "Copied $name to assets"
        fi
    done

    # Copy tile images and other media files present in installer dir
    for ext in png jpg jpeg webp mp3 mp4; do
        for f in "$script_dir"/*.$ext; do
            [ -f "$f" ] || continue
            # avoid duplicating files already copied
            bn=$(basename "$f")
            case "$bn" in
              applogo.png|bootlogo.png|startup.mp3|startup.mp4) continue;;
            esac
            cp -f "$f" "$ASSETS_DIR/" && info "Copied $bn to assets"
        done
    done
}

generate_placeholders(){
    # Create placeholder images for essential assets if missing using Pillow
    if check_cmd python3; then
        python3 - <<'XUI_HEREDOC_1' || true
from pathlib import Path
try:
        from PIL import Image, ImageDraw, ImageFont
except Exception:
        Image = None
AS = Path.home()/'.xui'/'assets'
AS.mkdir(parents=True, exist_ok=True)
if Image is not None:
        def make_img(fn, size=(320,180), text='XUI'):
                p = AS/fn
                if p.exists():
                        return
                try:
                        im = Image.new('RGBA', size, (12,84,166,255))
                        d = ImageDraw.Draw(im)
                        try:
                                f = ImageFont.truetype('DejaVuSans-Bold.ttf', max(24, size[1]//6))
                        except Exception:
                                f = ImageFont.load_default()
                        w,h = d.textsize(text, font=f)
                        d.text(((size[0]-w)/2,(size[1]-h)/2), text, fill=(255,255,255,255), font=f)
                        im.save(p)
                except Exception:
                        pass
        make_img('applogo.png', (512,512), 'XUI')
        make_img('bootlogo.png', (800,450), 'XUI')
    tiles = ['Casino','Runner','Store','Misiones','Perfil','Compat X86','LAN','Power Profile','Battery Saver','Salir al escritorio']
    XUI_HEREDOC_1
}

write_dashboard_py(){
     cat > "$DASH_DIR/pyqt_dashboard_improved.py" <<'XUI_HEREDOC_4'
    #!/usr/bin/env python3
    import sys
    import os
    import subprocess
    import time
    import random
    import json
    import shutil
    from pathlib import Path

    ASSETS = Path.home() / '.xui' / 'assets'
    DATA = Path.home() / '.xui' / 'data'
    DATA.mkdir(parents=True, exist_ok=True)
    SLOTS_FILE = DATA / 'slots.json'
    MISSIONS_FILE = DATA / 'missions.json'
    SETTINGS_FILE = DATA / 'settings.json'

    try:
        from PyQt5 import QtWidgets, QtGui, QtCore
    except Exception:
        print('PyQt5 not installed')
        sys.exit(1)


    class SlotMachineDialog(QtWidgets.QDialog):
        """Simple tragaperras (slots) with animated reels using emojis/text.
        Runs inside the dashboard as a modal dialog."""

        SYMBOLS = ['üçí', 'üîî', 'üçã', '‚≠ê', '7']

        def __init__(self, parent=None):
            super().__init__(parent)
            self.setWindowTitle('Casino - Tragaperras')
            self.setModal(True)

            try:
                data = json.load(open(SLOTS_FILE)) if SLOTS_FILE.exists() else {}
                self.credits = int(data.get('credits', 100))
            except Exception:
                self.credits = 100

            try:
                settings = json.load(open(SETTINGS_FILE)) if SETTINGS_FILE.exists() else {}
                self.sounds = bool(settings.get('sounds', True))
            except Exception:
                self.sounds = True

            v = QtWidgets.QVBoxLayout(self)
            h = QtWidgets.QHBoxLayout()
            self.reels = [QtWidgets.QLabel('') for _ in range(3)]
            for r in self.reels:
                r.setAlignment(QtCore.Qt.AlignCenter)
                f = r.font()
                f.setPointSize(48)
                r.setFont(f)
                r.setFixedSize(160, 160)
                r.setStyleSheet('background:#123; color:white; border-radius:8px;')
                h.addWidget(r)
            v.addLayout(h)

            ctr = QtWidgets.QHBoxLayout()
            self.spin_btn = QtWidgets.QPushButton('Girar (10 cr√©ditos)')
            self.spin_btn.clicked.connect(self.spin)
            self.credits_lbl = QtWidgets.QLabel(f'Cr√©ditos: {self.credits}')
            ctr.addWidget(self.spin_btn)
            ctr.addWidget(self.credits_lbl)
            v.addLayout(ctr)

            self.timers = [QtCore.QTimer(self) for _ in range(3)]
            for i, t in enumerate(self.timers):
                t.timeout.connect(lambda i=i: self._advance_reel(i))

        def _play_sound(self, fname):
            if not self.sounds:
                return
            path = ASSETS / fname
            if path.exists() and shutil.which('mpv'):
                try:
                    subprocess.Popen(['mpv', '--no-video', '--really-quiet', str(path)])
                except Exception:
                    pass

        def _advance_reel(self, i):
            self.reels[i].setText(random.choice(self.SYMBOLS))

        def spin(self):
            if self.credits < 10:
                QtWidgets.QMessageBox.information(self, 'Sin cr√©ditos', 'No tienes suficientes cr√©ditos')
                return
            self.credits -= 10
            self.credits_lbl.setText(f'Cr√©ditos: {self.credits}')
            self._play_sound('click.mp3')
            intervals = [50, 70, 90]
            durations = [800, 1400, 2000]
            for i, t in enumerate(self.timers):
                t.start(intervals[i])
                QtCore.QTimer.singleShot(durations[i], lambda t=t: t.stop())
            QtCore.QTimer.singleShot(max(durations) + 50, self._resolve)

        def _resolve(self):
            vals = [r.text() for r in self.reels]
            if vals[0] == vals[1] == vals[2]:
                win = 200 if vals[0] == '7' else 50
                self.credits += win
                QtWidgets.QMessageBox.information(self, 'Ganaste!', f'¬°Combinaci√≥n {vals[0]}! Ganaste {win} cr√©ditos')
                self._play_sound('startup.mp3')
            elif vals[0] == vals[1] or vals[1] == vals[2] or vals[0] == vals[2]:
                win = 20
                self.credits += win
                QtWidgets.QMessageBox.information(self, 'Peque√±o premio', f'Combinaci√≥n parcial {vals}. Ganaste {win} cr√©ditos')
                self._play_sound('startup.mp3')
            else:
                QtWidgets.QMessageBox.information(self, 'Suerte', 'No hubo premio')
            self.credits_lbl.setText(f'Cr√©ditos: {self.credits}')
            try:
                json.dump({'credits': self.credits}, open(SLOTS_FILE, 'w'))
            except Exception:
                pass


    class TileWidget(QtWidgets.QFrame):
        def __init__(self, name, img_path=None, parent=None, big=False):
            super().__init__(parent)
            self.name = name
            self.img_path = img_path
            self.big = big
            self.setObjectName('tile')
            self.setFocusPolicy(QtCore.Qt.StrongFocus)
            self.setStyleSheet(self.default_style())
            v = QtWidgets.QVBoxLayout(self)
            self.img_label = QtWidgets.QLabel()
            self.img_label.setAlignment(QtCore.Qt.AlignCenter)
            self.img_label.setFixedHeight(180 if big else 100)
            self.title = QtWidgets.QLabel(name)
            self.title.setAlignment(QtCore.Qt.AlignCenter)
            self.title.setStyleSheet('color:white;')
            v.addWidget(self.img_label)
            v.addWidget(self.title)
            self.anim = QtCore.QPropertyAnimation(self, b"geometry")

        def default_style(self):
            return "QFrame#tile { background: #0C54A6; border: 2px solid #08375a; border-radius:8px; } QLabel { color: white; }"

        def focusInEvent(self, e):
            rect = self.geometry()
            self.anim.stop()
            self.anim.setDuration(160)
            self.anim.setStartValue(rect)
            self.anim.setEndValue(QtCore.QRect(rect.x() - 6, rect.y() - 6, rect.width() + 12, rect.height() + 12))
            self.anim.start()
            self.setStyleSheet("QFrame#tile { background: #1E90FF; border: 3px solid #00FFFF; border-radius:8px; } QLabel { color: white; font-weight: bold; }")
            super().focusInEvent(e)

        def focusOutEvent(self, e):
            self.anim.stop()
            rect = self.geometry()
            self.anim.setDuration(120)
            self.anim.setStartValue(rect)
            self.anim.setEndValue(QtCore.QRect(rect.x() + 6, rect.y() + 6, rect.width() - 12, rect.height() - 12))
            self.anim.start()
            self.setStyleSheet(self.default_style())
            super().focusOutEvent(e)

        def mousePressEvent(self, e):
            win = QtWidgets.QApplication.activeWindow()
            if win and hasattr(win, 'on_tile_clicked'):
                win.on_tile_clicked(self.name)
            else:
                super().mousePressEvent(e)


    class MainWindow(QtWidgets.QMainWindow):
        def __init__(self, windowed=False):
            super().__init__()
            self.setWindowTitle('XUI GUI - Xbox Style')
            central = QtWidgets.QWidget()
            main_l = QtWidgets.QHBoxLayout(central)

            left = QtWidgets.QVBoxLayout()
            user_lbl = QtWidgets.QLabel('Usuario')
            user_lbl.setStyleSheet('color:white; font-weight:bold;')
            left.addWidget(user_lbl)
            left.addSpacing(10)
            left_tiles = ['Perfil', 'Compat X86']
            for t in left_tiles:
                lbl = QtWidgets.QLabel(t)
                lbl.setStyleSheet('background:#0C54A6; color:white; padding:8px; border-radius:6px;')
                lbl.setFixedHeight(48)
                left.addWidget(lbl)
                left.addSpacing(6)
            left.addStretch()
            left_widget = QtWidgets.QFrame()
            left_widget.setLayout(left)
            left_widget.setFixedWidth(180)
            left_widget.setStyleSheet('background: #000;')

            center = QtWidgets.QWidget()
            grid = QtWidgets.QGridLayout(center)
            hero = TileWidget('Casino', ASSETS / 'Casino.png', big=True)
            grid.addWidget(hero, 0, 0, 2, 2)
            others = ['Runner', 'Store', 'Misiones', 'LAN', 'Settings', 'Power Profile', 'Battery Saver']
            positions = [(0, 2), (1, 2), (2, 0), (2, 1), (2, 2), (3, 0), (3, 1)]
            self.tiles = [hero]
            for name, pos in zip(others, positions):
                img_webp = ASSETS / (f"{name}.webp")
                img_png = ASSETS / (f"{name}.png")
                img = img_webp if img_webp.exists() else (img_png if img_png.exists() else None)
                tw = TileWidget(name, img if img is not None else None, big=False)
                grid.addWidget(tw, pos[0], pos[1])
                self.tiles.append(tw)

            right = QtWidgets.QVBoxLayout()
            right_title = QtWidgets.QLabel('Featured')
            right_title.setStyleSheet('color:white; font-weight:bold')
            right.addWidget(right_title)
            for i in range(4):
                lbl = QtWidgets.QLabel(f'Featured {i+1}')
                lbl.setFixedHeight(70)
                lbl.setStyleSheet('background:#111; color:white; border:1px solid #333; padding:6px;')
                right.addWidget(lbl)
                right.addSpacing(8)
            right.addStretch()
            right_widget = QtWidgets.QFrame()
            right_widget.setLayout(right)
            right_widget.setFixedWidth(240)

            main_l.addWidget(left_widget)
            main_l.addWidget(center, 1)
            main_l.addWidget(right_widget)

            self.setCentralWidget(central)
            self.current_index = 0
            QtCore.QTimer.singleShot(120, self.update_focus)
            self.windowed = windowed

        def update_focus(self):
            if 0 <= self.current_index < len(self.tiles):
                self.tiles[self.current_index].setFocus()

        def on_tile_clicked(self, name):
            xui = str(Path.home() / '.xui')
            if name == 'Casino':
                dlg = SlotMachineDialog(self)
                dlg.exec_()
            elif name == 'LAN':
                dlg = QtWidgets.QDialog(self)
                dlg.setWindowTitle('LAN Info')
                t = QtWidgets.QPlainTextEdit()
                t.setReadOnly(True)
                try:
                    out = subprocess.getoutput('ip -4 addr show | sed -n "1,40p"')
                except Exception:
                    out = 'Could not run ip command'
                t.setPlainText(out)
                l = QtWidgets.QVBoxLayout(dlg)
                l.addWidget(t)
                b = QtWidgets.QPushButton('Cerrar')
                b.clicked.connect(dlg.accept)
                l.addWidget(b)
                dlg.exec_()
            elif name == 'Settings':
                dlg = QtWidgets.QDialog(self)
                dlg.setWindowTitle('Settings')
                layout = QtWidgets.QVBoxLayout(dlg)
                sounds_cb = QtWidgets.QCheckBox('Enable sounds')
                try:
                    s = json.load(open(SETTINGS_FILE)) if SETTINGS_FILE.exists() else {}
                    sounds_cb.setChecked(bool(s.get('sounds', True)))
                except Exception:
                    sounds_cb.setChecked(True)
                layout.addWidget(sounds_cb)
                reset_btn = QtWidgets.QPushButton('Reset slot credits')

                def do_reset():
                    try:
                        json.dump({'credits': 100}, open(SLOTS_FILE, 'w'))
                        QtWidgets.QMessageBox.information(dlg, 'Reset', 'Credits reset to 100')
                    except Exception:
                        QtWidgets.QMessageBox.warning(dlg, 'Error', 'Could not reset')

                reset_btn.clicked.connect(do_reset)
                layout.addWidget(reset_btn)
                ok = QtWidgets.QPushButton('Guardar')

                def save_settings():
                    try:
                        json.dump({'sounds': bool(sounds_cb.isChecked())}, open(SETTINGS_FILE, 'w'))
                        dlg.accept()
                    except Exception:
                        dlg.reject()

                ok.clicked.connect(save_settings)
                layout.addWidget(ok)
                dlg.exec_()
            elif name == 'Misiones':
                dlg = QtWidgets.QDialog(self)
                dlg.setWindowTitle('Misiones')
                l = QtWidgets.QVBoxLayout(dlg)
                try:
                    missions = json.load(open(MISSIONS_FILE)) if MISSIONS_FILE.exists() else [{'title': 'Demo Mision', 'desc': 'Haz algo divertido'}]
                except Exception:
                    missions = [{'title': 'Demo Mision', 'desc': 'Haz algo divertido'}]
                for m in missions:
                    w = QtWidgets.QGroupBox(m.get('title', 'Mision'))
                    v = QtWidgets.QVBoxLayout()
                    v.addWidget(QtWidgets.QLabel(m.get('desc', '')))
                    w.setLayout(v)
                    l.addWidget(w)
                btn = QtWidgets.QPushButton('Cerrar')
                btn.clicked.connect(dlg.accept)
                l.addWidget(btn)
                dlg.exec_()
            else:
                candidate = os.path.join(xui, name.lower(), f"{name}.py")
                if os.path.exists(candidate):
                    QtCore.QProcess.startDetached(sys.executable, [candidate])
                else:
                    script = os.path.join(xui, 'bin', f'xui_{name.lower()}.sh')
                    if os.path.exists(script):
                        QtCore.QProcess.startDetached('/bin/sh', ['-c', script])


    if __name__ == '__main__':
        windowed = '--windowed' in sys.argv
        app = QtWidgets.QApplication(sys.argv)
        app.setStyleSheet('''
            QWidget { background: #0b0f13; color: #e6eef6; }
            QFrame#tile { background: #0C54A6; border-radius: 8px; }
            QLabel { color: #e6eef6; }
            QPushButton { background: #154a70; color: #fff; border-radius:6px; padding:8px; }
        ''')
        w = MainWindow(windowed=windowed)
        try:
            if not windowed:
                w.showFullScreen()
            else:
                w.resize(1200, 720)
                w.show()
        except Exception:
            w.show()
    sys.exit(app.exec_())
    # Preserve trailing duplicate dashboard block in a non-executed string to avoid IndentationError
    _DUPLICATE_BLOCK = '''
    elif name == 'Settings':
            dlg = QtWidgets.QDialog(self)
            dlg.setWindowTitle('Settings')
            layout = QtWidgets.QVBoxLayout(dlg)
            sounds_cb = QtWidgets.QCheckBox('Enable sounds')
            try:
                s = json.load(open(SETTINGS_FILE)) if SETTINGS_FILE.exists() else {}
                sounds_cb.setChecked(bool(s.get('sounds', True)))
            except Exception:
                sounds_cb.setChecked(True)
            layout.addWidget(sounds_cb)
            reset_btn = QtWidgets.QPushButton('Reset slot credits')
            def do_reset():
                try:
                    json.dump({'credits':100}, open(SLOTS_FILE,'w'))
                    QtWidgets.QMessageBox.information(dlg,'Reset','Credits reset to 100')
                except Exception:
                    QtWidgets.QMessageBox.warning(dlg,'Error','Could not reset')
            reset_btn.clicked.connect(do_reset)
            layout.addWidget(reset_btn)
            ok = QtWidgets.QPushButton('Guardar')
            def save_settings():
                try:
                    json.dump({'sounds': bool(sounds_cb.isChecked())}, open(SETTINGS_FILE,'w'))
                    dlg.accept()
                except Exception:
                    dlg.reject()
            ok.clicked.connect(save_settings)
            layout.addWidget(ok)
            dlg.exec_()
        elif name == 'Misiones' or name == 'Misiones':
            # show missions list
            dlg = QtWidgets.QDialog(self)
            dlg.setWindowTitle('Misiones')
            l = QtWidgets.QVBoxLayout(dlg)
            try:
                missions = json.load(open(MISSIONS_FILE)) if MISSIONS_FILE.exists() else [{'title':'Demo Mision','desc':'Haz algo divertido'}]
            except Exception:
                missions = [{'title':'Demo Mision','desc':'Haz algo divertido'}]
            for m in missions:
                w = QtWidgets.QGroupBox(m.get('title','Mision'))
                v = QtWidgets.QVBoxLayout()
                v.addWidget(QtWidgets.QLabel(m.get('desc','')))
                w.setLayout(v)
                l.addWidget(w)
            btn = QtWidgets.QPushButton('Cerrar')
            btn.clicked.connect(dlg.accept)
            l.addWidget(btn)
            dlg.exec_()
        else:
            # fallback: start external script if present
            candidate = os.path.join(xui, name.lower(), f"{name}.py")
            if os.path.exists(candidate):
                QtCore.QProcess.startDetached(sys.executable, [candidate])
            else:
                script = os.path.join(xui, 'bin', f'xui_{name.lower()}.sh')
                if os.path.exists(script):
                    QtCore.QProcess.startDetached('/bin/sh', ['-c', script])


if __name__=='__main__':
    windowed = '--windowed' in sys.argv
    app = QtWidgets.QApplication(sys.argv)
    # dark mode stylesheet
    app.setStyleSheet('''
        QWidget { background: #0b0f13; color: #e6eef6; }
        QFrame#tile { background: #0C54A6; border-radius: 8px; }
        QLabel { color: #e6eef6; }
        QPushButton { background: #154a70; color: #fff; border-radius:6px; padding:8px; }
    ''')
    w = MainWindow(windowed=windowed)
    try:
        if not windowed:
            w.showFullScreen()
        else:
            w.resize(1200,720)
            w.show()
    except Exception:
        w.show()
    sys.exit(app.exec_())
        '''
XUI_HEREDOC_4
    chmod a+x "$DASH_DIR/pyqt_dashboard_improved.py" || true
    info "Wrote dashboard to $DASH_DIR/pyqt_dashboard_improved.py"
}

write_startup_wrapper(){
  cat > "$BIN_DIR/xui_startup_and_dashboard.sh" <<'XUI_HEREDOC_5'
#!/usr/bin/env bash
set -euo pipefail
ASSETS_DIR="$HOME/.xui/assets"
DASH_SCRIPT="$HOME/.xui/dashboard/pyqt_dashboard_improved.py"
info(){ echo "[INFO] $*"; }
if [ -f "$ASSETS_DIR/startup.mp3" ] && command -v mpv >/dev/null 2>&1; then
    mpv --no-video --really-quiet "$ASSETS_DIR/startup.mp3" &
fi
if [ -f "$ASSETS_DIR/startup.mp4" ] && command -v mpv >/dev/null 2>&1; then
    # play video in background then launch dashboard
    mpv --fs --really-quiet "$ASSETS_DIR/startup.mp4" &
fi
if [ -f "$DASH_SCRIPT" ]; then
    exec python3 "$DASH_SCRIPT"
else
    echo "Dashboard script not found: $DASH_SCRIPT" >&2
    exit 1
fi
XUI_HEREDOC_5
  chmod a+x "$BIN_DIR/xui_startup_and_dashboard.sh" || true
  info "Wrote startup wrapper to $BIN_DIR/xui_startup_and_dashboard.sh"
}

write_autostart(){
  cat > "$AUTOSTART_DIR/xui-dashboard.desktop" <<'XUI_HEREDOC_6'
[Desktop Entry]
Type=Application
Name=XUI Dashboard
Exec=$BIN_DIR/xui_startup_and_dashboard.sh
Terminal=false
StartupNotify=false
X-GNOME-Autostart-enabled=true
Hidden=false
XUI_HEREDOC_6
  info "Wrote autostart desktop to $AUTOSTART_DIR/xui-dashboard.desktop"
}

install_media_tools_if_requested(){
    # Optionally install common media tools (mpv, ffmpeg, cwebp) if user allows.
    # Set AUTO_INSTALL_TOOLS=1 to attempt automatic installation (uses sudo when necessary).
    pkgs=(mpv ffmpeg cwebp)
    # add GUI and Pillow when apt is available & user requested system install
    if command -v apt >/dev/null 2>&1; then
        gui_pkgs=(python3-pip python3-pyqt5 python3-pil)
    else
        gui_pkgs=()
    fi
    # map to distro packages when possible
    if command -v apt >/dev/null 2>&1; then
        instal_cmd="sudo apt update && sudo apt install -y"
    elif command -v dnf >/dev/null 2>&1; then
        instal_cmd="sudo dnf install -y"
    elif command -v pacman >/dev/null 2>&1; then
        instal_cmd="sudo pacman -S --noconfirm"
    else
        instal_cmd=""
    fi

    missing=()
    for p in "${pkgs[@]}"; do
        if ! command -v "$p" >/dev/null 2>&1; then
            missing+=($p)
        fi
    done

    if [ ${#missing[@]} -eq 0 ]; then
        info "All media tools present: ${pkgs[*]}"
        return 0
    fi

    info "Missing media tools: ${missing[*]}"
    if [ "${AUTO_INSTALL_TOOLS:-0}" = "1" ] && [ -n "$instal_cmd" ]; then
        info "Attempting to install missing tools: ${missing[*]}"
        # install media tools
        $instal_cmd ${missing[*]} || warn "Automatic install failed; please install: ${missing[*]}"
        # if apt, also install GUI deps
        if command -v apt >/dev/null 2>&1; then
            info "Attempting to install GUI Python packages: ${gui_pkgs[*]}"
            sudo apt update || true
            sudo apt install -y ${gui_pkgs[*]} || warn "Could not install GUI packages: ${gui_pkgs[*]}"
            # try pip install Pillow in user site
            pip_install Pillow || warn "Could not pip-install Pillow"
        fi
    else
        info "To install missing tools, run:"
        if [ -n "$instal_cmd" ]; then
            echo "$instal_cmd ${missing[*]}"
        else
            echo "Install ${missing[*]} with your distro package manager (apt/dnf/pacman)"
        fi
        info "Or set AUTO_INSTALL_TOOLS=1 and re-run the installer to attempt auto-install"
    fi
}

write_web_control(){
    mkdir -p "$BIN_DIR"
    cat > "$BIN_DIR/xui_web_api.py" <<'XUI_HEREDOC_7'
#!/usr/bin/env python3
"""Minimal XUI web-control API (best-effort placeholder).
This small server exposes a tiny control endpoint and can be replaced later.
"""
import http.server, socketserver, json, os, subprocess

XUI = os.path.expanduser('~/.xui')

class Handler(http.server.SimpleHTTPRequestHandler):
    def do_GET(self):
        # Simple health endpoint
        if self.path == '/status':
            res = {'status':'ok'}
            self.send_response(200)
            self.send_header('Content-Type','application/json')
            self.end_headers()
            self.wfile.write(json.dumps(res).encode())
            return
        return http.server.SimpleHTTPRequestHandler.do_GET(self)

def serve(port=8020):
    with socketserver.TCPServer(('0.0.0.0',port), Handler) as httpd:
        print(f'XUI web-control listening on {port}')
        httpd.serve_forever()

if __name__=='__main__':
    serve()
XUI_HEREDOC_7
    chmod +x "$BIN_DIR/xui_web_api.py" || true

    cat > "$BIN_DIR/xui_web_control.sh" <<'XUI_HEREDOC_8'
#!/usr/bin/env bash
PORT=${1:-8020}
python3 "$HOME/.xui/bin/xui_web_api.py" &
echo "web-control started on port $PORT"
XUI_HEREDOC_8
    chmod +x "$BIN_DIR/xui_web_control.sh" || true
}

write_theme_toggle(){
    info "Writing theme toggle utility"
    cat > "$BIN_DIR/xui_theme.sh" <<'XUI_HEREDOC_9'
#!/usr/bin/env bash
THEMEDIR="$HOME/.xui/data"
FILE="$THEMEDIR/theme.json"
mkdir -p "$THEMEDIR"
CUR=$(cat "$FILE" 2>/dev/null || echo '{"name":"default"}')
case ${1:-toggle} in
    toggle)
        NAME=$(python3 - <<'XUI_HEREDOC_10'
import json
f='$FILE'
try:
        d=json.load(open(f))
except Exception:
        d={'name':'default'}
n='dark' if d.get('name')=='default' else 'default'
print(n)
XUI_HEREDOC_10
)
        echo "{\"name\":\"$NAME\"}" > "$FILE"; echo "$NAME"; ;;
    set)
        echo "{\"name\":\"${2:-default}\"}" > "$FILE"; echo set;;
    *) echo "Usage: $0 {toggle|set <name>}"; exit 1;;
esac
XUI_HEREDOC_9
    chmod +x "$BIN_DIR/xui_theme.sh"
}

write_volume_brightness_scripts(){
    info "Writing volume/brightness helper scripts"
    cat > "$BIN_DIR/xui_set_volume.sh" <<'XUI_HEREDOC_11'
#!/usr/bin/env bash
set -euo pipefail
V=${1:-50}
if command -v pactl >/dev/null 2>&1; then
    pactl set-sink-volume @DEFAULT_SINK@ ${V}%
else
    echo "pactl not available"
fi
XUI_HEREDOC_11
    chmod +x "$BIN_DIR/xui_set_volume.sh"

    cat > "$BIN_DIR/xui_set_brightness.sh" <<'XUI_HEREDOC_12'
#!/usr/bin/env bash
set -euo pipefail
V=${1:-50}
if command -v brightnessctl >/dev/null 2>&1; then
    brightnessctl set ${V}%
elif command -v xbacklight >/dev/null 2>&1; then
    xbacklight -set ${V}
else
    echo "brightnessctl/xbacklight not available"
fi
XUI_HEREDOC_12
    chmod +x "$BIN_DIR/xui_set_brightness.sh"
    info "Wrote $BIN_DIR/xui_set_volume.sh and xui_set_brightness.sh"
}

# Joy listener as standalone script (user systemd service will reference it)
write_joy_py(){
  info "Writing joy listener to $BIN_DIR/xui_joy_listener.py"
  cat > "$BIN_DIR/xui_joy_listener.py" <<'XUI_HEREDOC_13'
#!/usr/bin/env python3
"""Simple Joy listener: map event codes to xdotool keys
Runs as user service. Keeps minimal logic so dashboard can also run its own listener.
"""
import time, os, subprocess
try:
    from evdev import list_devices, InputDevice
except Exception:
    # evdev missing
    list_devices = lambda: []

KEYMAP = {
    # example mapping; device-specific codes vary
    '304':'Return', '305':'Escape', '16':'Left', '17':'Right', '103':'Up', '108':'Down'
}

def find_and_listen():
    for p in list_devices():
        try:
            d = InputDevice(p)
            if 'joystick' in d.name.lower() or 'gamepad' in d.name.lower() or 'joy' in d.name.lower():
                for ev in d.read_loop():
                    if ev.type == 1 and ev.value == 1:
                        k = KEYMAP.get(str(ev.code))
                        if k:
                            subprocess.run(['xdotool','key',k])
        except Exception:
            continue

if __name__ == '__main__':
    while True:
        try:
            find_and_listen()
        except Exception:
            time.sleep(2)
XUI_HEREDOC_13
  chmod +x "$BIN_DIR/xui_joy_listener.py"
}

# Create small casino, store, missions scripts (safe, robust)
write_extras(){
  info "Writing casino, store and helper scripts"
  mkdir -p "$CASINO_DIR"
  cat > "$CASINO_DIR/casino.py" <<'XUI_HEREDOC_14'
#!/usr/bin/env python3
import json, os, random, time, subprocess, sys

DATA=os.path.expanduser('~/.xui/data/saldo.json')

def load():
    try:
        return json.load(open(DATA)).get('balance',0.0)
    except Exception:
        return 0.0

def save(b):
    json.dump({'balance':round(b,2),'currency':'EUR'}, open(DATA,'w'))

def spin_animation(final):
    # simple textual roulette spin animation
    wheel = list(range(0,37))
    seq = []
    # create a long sequence that ends at final
    for r in range(6):
        seq.extend(wheel)
    seq.extend(wheel[:(final+1)])
    delay = 0.02
    for i, num in enumerate(seq):
        # slow down towards the end
        if i > len(seq) * 0.6:
            delay += 0.006
        sys.stdout.write('\rGirando... [' + str(num) + ']')
        sys.stdout.flush()
        time.sleep(delay)
    sys.stdout.write('\n')

def confetti():
    # small celebratory animation
    for _ in range(6):
        sys.stdout.write('. ')
        sys.stdout.flush()
        time.sleep(0.08)
    sys.stdout.write('\n')

if __name__=='__main__':
    b = load()
    print(f"Saldo: ‚Ç¨{b:.2f}")
    try:
        bet = float(input('Apuesta: '))
    except Exception:
        print('Inv√°lido'); exit(1)
    if bet<=0 or bet>b:
        print('Apuesta inv√°lida'); exit(1)
    final = random.randint(0,36)
    spin_animation(final)
    n = final
    if n==0:
        win = -bet
    elif n%2==0:
        win = bet*2
    else:
        win = -bet
    b += win
    save(b)
    if win>0:
        print('¬°Ganaste!', win)
        confetti()
    else:
        print('Perdiste', -win)
    try:
        subprocess.call(['notify-send','Casino','Resultado: '+str(win)])
    except Exception:
        pass
XUI_HEREDOC_14
  chmod +x "$CASINO_DIR/casino.py"

  cat > "$BIN_DIR/xui_store.sh" <<'XUI_HEREDOC_15'
#!/usr/bin/env bash
set -euo pipefail
STORE="$HOME/.xui/data/store.json"
BALSCRIPT="$HOME/.xui/bin/xui_balance.sh"
if [ ! -f "$STORE" ]; then echo "No store"; exit 1; fi
jq -r '.items[] | "\(.id) | \(.name) | ‚Ç¨\(.price)"' "$STORE" | nl -w2 -s'. '
read -p "ID del item (ENTER salir): " ID
[ -z "$ID" ] && exit 0
ITEM=$(jq -r --arg id "$ID" '.items[] | select(.id==$id) | @json' "$STORE")
[ -z "$ITEM" ] && echo "No encontrado" && exit 1
PRICE=$(echo "$ITEM" | jq -r '.price')
NAME=$(echo "$ITEM" | jq -r '.name')
# naive balance change
BALFILE="$HOME/.xui/data/saldo.json"
CUR=$(python3 -c "import json;print(json.load(open('$BALFILE')).get('balance',0.0))")
echo "Comprar $NAME por ‚Ç¨$PRICE (saldo ‚Ç¨$CUR)"
read -p "Confirmar (s/N): " c
case "$c" in [sS]) python3 - <<'XUI_HEREDOC_16'
import json
f='$BALFILE'
d=json.load(open(f))
if d.get('balance',0.0) < $PRICE:
    print('Saldo insuficiente'); raise SystemExit(1)
d['balance']=round(d.get('balance',0.0)-$PRICE,2)
json.dump(d,open(f,'w'))
print('Compra OK')
XUI_HEREDOC_16
;; *) echo "Cancelado"; exit 0;; esac
XUI_HEREDOC_15
  chmod +x "$BIN_DIR/xui_store.sh"

  # balance helper
  cat > "$BIN_DIR/xui_balance.sh" <<'XUI_HEREDOC_17'
#!/usr/bin/env bash
set -euo pipefail
DATA="$HOME/.xui/data/saldo.json"
cmd=${1:-get}
amt=${2:-0}
case "$cmd" in
  get)
    python3 - <<'XUI_HEREDOC_18'
import json
try:
    print(json.load(open('$DATA')).get('balance',0.0))
except Exception:
    print(0.0)
XUI_HEREDOC_18
    ;;
  add)
    python3 - <<'XUI_HEREDOC_19'
import json
f='$DATA'
d=json.load(open(f))
d['balance']=round(d.get('balance',0.0)+float($amt),2)
json.dump(d,open(f,'w'))
print(d['balance'])
XUI_HEREDOC_19
    ;;
  sub)
    python3 - <<'XUI_HEREDOC_20'
import json,sys
f='$DATA'
d=json.load(open(f))
new=d.get('balance',0.0)-float($amt)
if new<0:
    sys.exit(1)
d['balance']=round(new,2)
json.dump(d,open(f,'w'))
print(d['balance'])
XUI_HEREDOC_20
    ;;
  set)
    python3 - <<'XUI_HEREDOC_21'
import json
f='$DATA'
d=json.load(open(f))
d['balance']=round(float($amt),2)
json.dump(d,open(f,'w'))
print(d['balance'])
XUI_HEREDOC_21
    ;;
  *) echo "Usage: $0 {get|add|sub|set} [amount]"; exit 1;;
esac
XUI_HEREDOC_17
  chmod +x "$BIN_DIR/xui_balance.sh"
}

# Systemd user units and autostart wrapper
write_systemd_and_autostart(){
  info "Creating systemd user units and autostart wrapper"
  cat > "$SYSTEMD_USER_DIR/xui-dashboard.service" <<'XUI_HEREDOC_22'
[Unit]
Description=XUI Dashboard (user)

After=graphical-session.target

[Service]
Type=simple
ExecStart=/usr/bin/python3 %h/.xui/dashboard/pyqt_dashboard_improved.py
# Ensure a display and runtime dir are available for GUI startup under systemd --user
Environment=DISPLAY=:0
Environment=XDG_RUNTIME_DIR=/run/user/%U
Restart=on-failure

[Install]
WantedBy=default.target
XUI_HEREDOC_22

  cat > "$SYSTEMD_USER_DIR/xui-joy.service" <<'XUI_HEREDOC_23'
[Unit]
Description=XUI Joy Listener (user)

[Service]
Type=simple
ExecStart=%h/.xui/bin/xui_joy_listener.py
Restart=on-failure

[Install]
WantedBy=default.target
XUI_HEREDOC_23

  cat > "$BIN_DIR/xui_start.sh" <<'XUI_HEREDOC_24'
#!/usr/bin/env bash
# Wrapper to start Dashboard only if graphical session present
sleep 2
# Determine runtime display variables for Wayland/X11
if [ -n "${WAYLAND_DISPLAY:-}" ]; then
    export WAYLAND_DISPLAY="${WAYLAND_DISPLAY}"
    # Some Qt builds use WAYLAND_DISPLAY; also set DISPLAY if not set
    export DISPLAY="${DISPLAY:-:0}"
else
    export DISPLAY="${DISPLAY:-:0}"
fi
# Ensure XDG_RUNTIME_DIR is set (typical for systemd --user)
export XDG_RUNTIME_DIR="${XDG_RUNTIME_DIR:-/run/user/$(id -u)}"

SCRIPT="$HOME/.xui/dashboard/pyqt_dashboard_improved.py"
# Try preferred terminals to launch fullscreen GUI, fallback to direct python
if command -v konsole >/dev/null 2>&1; then
    konsole --fullscreen --hide-menubar -e python3 "$SCRIPT"
elif command -v gnome-terminal >/dev/null 2>&1; then
    gnome-terminal --full-screen -- python3 "$SCRIPT"
elif command -v xterm >/dev/null 2>&1; then
    xterm -fullscreen -e python3 "$SCRIPT"
else
    python3 "$SCRIPT"
fi
XUI_HEREDOC_24
  chmod +x "$BIN_DIR/xui_start.sh"

  cat > "$AUTOSTART_DIR/xui-dashboard.desktop" <<'XUI_HEREDOC_25'
[Desktop Entry]
Type=Application
Name=XUI Dashboard
Exec=$BIN_DIR/xui_startup_and_dashboard.sh
Icon=$ASSETS_DIR/logo.png
Terminal=false
StartupNotify=false
X-GNOME-Autostart-enabled=true
Hidden=false
XUI_HEREDOC_25

# Ensure assets/logo.png exists: prefer installer-provided logo in script dir, else try to generate a placeholder with Pillow
mkdir -p "$ASSETS_DIR"
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
# --- Embedded asset blobs (replace placeholders with actual base64 to embed files) ---
# To embed files, replace the placeholder values below with the base64 contents (no newlines required).
# Example (posix):
#   base64 -w0 logo.png | sed 's/^/"/' | sed 's/$/"/' >> xui8.5.sh (insert between the triple quotes)
EMBED_LOGO_B64="$(cat <<'XUI_HEREDOC_26'
iVBORw0KGgoAAAANSUhEUgAAAwAAAAQACAIAAABv3i4WAAAgAElEQVR4nOydd3wcxZ3/3+u
7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u
7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7v8n8z8z8z8z8z8z8z8z8z8z8z8z
8z8z8z8z8z8z8z8z8z8z8z8z8z8z8z8z8z8z8z8z8z8z8z8z8z8z8z8z8z8z8z8z8z8z8
z8z8z8z8z8z8z8z8z8z8z8z8z8z8z8z8z8z8z8z8z8z8z8z8z8z8z8z8z8z8z8z8z8z8z
8z8z8z8z8z8z8z8z8z8z8z8z8z8z8z8z8z8z8z8z8z8z8z8z8z8z8z8z8z8z8z8z8z8z8
z8z8z8z8z8z8z8z8z8z8z8z8z8z8z8z8z8z8z8z8z8z8z8z8z8z8z8z8z8z8z8z8z8z8z
...REDACTED_FOR_BREVITY...
XUI_HEREDOC_26
 )"
EMBED_LOGO1_B64="__LOGO1_B64_PLACEHOLDER__"
EMBED_LOGO2_B64="__LOGO2_B64_PLACEHOLDER__"
EMBED_STARTUP_MP4_B64="__MP4_B64_PLACEHOLDER__"
EMBED_STARTUP_MP3_B64="__MP3_B64_PLACEHOLDER__"

# Decode embedded blobs (if present) into $ASSETS_DIR
if [ -n "$EMBED_LOGO_B64" ] && [ "$EMBED_LOGO_B64" != "__LOGO_B64_PLACEHOLDER__" ]; then
    echo "$EMBED_LOGO_B64" | base64 -d > "$ASSETS_DIR/logo.png" && info "Wrote embedded logo to $ASSETS_DIR/logo.png"
fi
if [ -n "$EMBED_LOGO1_B64" ] && [ "$EMBED_LOGO1_B64" != "__LOGO1_B64_PLACEHOLDER__" ]; then
    echo "$EMBED_LOGO1_B64" | base64 -d > "$ASSETS_DIR/logo1.png" && info "Wrote embedded logo1 to $ASSETS_DIR/logo1.png"
fi
if [ -n "$EMBED_LOGO2_B64" ] && [ "$EMBED_LOGO2_B64" != "__LOGO2_B64_PLACEHOLDER__" ]; then
    echo "$EMBED_LOGO2_B64" | base64 -d > "$ASSETS_DIR/logo2.png" && info "Wrote embedded logo2 to $ASSETS_DIR/logo2.png"
fi
if [ -n "$EMBED_STARTUP_MP4_B64" ] && [ "$EMBED_STARTUP_MP4_B64" != "__MP4_B64_PLACEHOLDER__" ]; then
    echo "$EMBED_STARTUP_MP4_B64" | base64 -d > "$ASSETS_DIR/startup.mp4" && info "Wrote embedded startup.mp4 to $ASSETS_DIR/startup.mp4"
fi
if [ -n "$EMBED_STARTUP_MP3_B64" ] && [ "$EMBED_STARTUP_MP3_B64" != "__MP3_B64_PLACEHOLDER__" ]; then
    echo "$EMBED_STARTUP_MP3_B64" | base64 -d > "$ASSETS_DIR/startup.mp3" && info "Wrote embedded startup.mp3 to $ASSETS_DIR/startup.mp3"
fi
if [ -f "$SCRIPT_DIR/logo.png" ]; then
    cp "$SCRIPT_DIR/logo.png" "$ASSETS_DIR/logo.png"
    info "Copied installer logo to $ASSETS_DIR/logo.png"
else
    if command -v python3 >/dev/null 2>&1; then
        python3 - <<'XUI_HEREDOC_27' || true
try:
    from PIL import Image, ImageDraw, ImageFont
    import os
    out=os.path.expanduser('~/.xui/assets/logo.png')
    os.makedirs(os.path.dirname(out), exist_ok=True)
    im=Image.new('RGBA',(512,512),(12,84,166,255))
    d=ImageDraw.Draw(im)
    try:
        f=ImageFont.truetype('DejaVuSans-Bold.ttf',72)
    except Exception:
        f=None
    text='XGUI'
    w,h=d.textsize(text,font=f)
    d.text(((512-w)/2,(512-h)/2),text,fill=(255,255,255,255),font=f)
    im.save(out)
    print('logo_generated')
except Exception:
    pass
XUI_HEREDOC_27
        info "Generated placeholder logo at $ASSETS_DIR/logo.png (if Pillow available)"
    else
        warn "No installer logo found and python3 not available to generate placeholder logo. Place $SCRIPT_DIR/logo.png manually into the installer directory."
    fi
fi

# Generate placeholder exit icon if missing
if [ ! -f "$ASSETS_DIR/Salir al escritorio.png" ]; then
    if command -v python3 >/dev/null 2>&1; then
        python3 - <<'XUI_HEREDOC_28' || true
try:
    from PIL import Image, ImageDraw, ImageFont
    import os
    out=os.path.expanduser('~/.xui/assets/Salir al escritorio.png')
    os.makedirs(os.path.dirname(out), exist_ok=True)
    im=Image.new('RGBA',(320,180),(12,84,166,255))
    d=ImageDraw.Draw(im)
    try:
        f=ImageFont.truetype('DejaVuSans-Bold.ttf',28)
    except Exception:
        f=None
    txt='Salir'
    w,h=d.textsize(txt,font=f)
    d.text(((320-w)/2,(180-h)/2),txt,fill=(255,255,255,255),font=f)
    im.save(out)
    print('exit_icon_generated')
except Exception:
    pass
XUI_HEREDOC_28
    fi
fi

# Copy optional startup video and sound if provided next to the installer
# Also copy optional installer images if present (applogo/bootlogo)
if [ -f "$SCRIPT_DIR/applogo.png" ]; then
    cp "$SCRIPT_DIR/applogo.png" "$ASSETS_DIR/logo.png"
    info "Copied applogo.png to $ASSETS_DIR/logo.png"
fi
if [ -f "$SCRIPT_DIR/bootlogo.png" ]; then
    cp "$SCRIPT_DIR/bootlogo.png" "$ASSETS_DIR/logo1.png"
    info "Copied bootlogo.png to $ASSETS_DIR/logo1.png"
fi
if [ -f "$SCRIPT_DIR/startup.mp4" ]; then
    cp "$SCRIPT_DIR/startup.mp4" "$ASSETS_DIR/startup.mp4"
    info "Copied startup video to $ASSETS_DIR/startup.mp4"
fi
if [ -f "$SCRIPT_DIR/startup.mp3" ]; then
    cp "$SCRIPT_DIR/startup.mp3" "$ASSETS_DIR/startup.mp3"
    info "Copied startup sound to $ASSETS_DIR/startup.mp3"
fi

# Copy any other mp3 assets from installer dir into assets (click, hover, achievements, etc.)
for f in "$SCRIPT_DIR"/*.mp3; do
    if [ -f "$f" ]; then
        cp "$f" "$ASSETS_DIR/" && info "Copied $(basename "$f") to $ASSETS_DIR/"
    fi
done

# Create a manifest of assets installed
mkdir -p "$ASSETS_DIR"
# Try to convert PNG images to WebP (use cwebp if available, else Pillow)
if command -v cwebp >/dev/null 2>&1; then
  for p in "$ASSETS_DIR"/*.png; do
    [ -f "$p" ] || continue
    outp="${p%.*}.webp"
    cwebp -q 80 "$p" -o "$outp" >/dev/null 2>&1 || true
  done
elif command -v python3 >/dev/null 2>&1; then
  python3 - <<'XUI_HEREDOC_29' || true
import os
from pathlib import Path
try:
    from PIL import Image
except Exception:
    Image = None
ad = Path.home()/'.xui'/'assets'
if Image is not None:
    for p in ad.glob('*.png'):
        out = p.with_suffix('.webp')
        try:
            img = Image.open(p).convert('RGBA')
            img.save(out, 'WEBP', quality=80)
        except Exception:
            pass
XUI_HEREDOC_29
fi

# Generate manifest listing assets; prefer .webp when present (dashboard will try webp first)
python3 - <<'XUI_HEREDOC_30' || true
import os, json
ad = os.path.expanduser('~/.xui/assets')
files = []
names = sorted(os.listdir(ad))
seen = set()
for fn in names:
    base, ext = os.path.splitext(fn)
    if base in seen:
        continue
    # prefer webp over png
    if os.path.exists(os.path.join(ad, base + '.webp')):
        files.append(base + '.webp')
        seen.add(base)
    elif os.path.exists(os.path.join(ad, base + '.png')):
        files.append(base + '.png')
        seen.add(base)
    else:
        files.append(fn)
        seen.add(base)
out = {'assets': files}
with open(os.path.join(ad,'manifest.json'),'w') as fh:
    json.dump(out, fh, indent=2)
print('manifest_written')
XUI_HEREDOC_30
info "Wrote $ASSETS_DIR/manifest.json"

# Ensure applogo and bootlogo are present in assets (already handled above if provided),
# and create a startup wrapper that will play startup.mp3 & startup.mp4 and show bootlogo.png if needed
mkdir -p "$BIN_DIR"
cat > "$BIN_DIR/xui_startup_and_dashboard.sh" <<'XUI_HEREDOC_31'
#!/usr/bin/env bash
set -euo pipefail

ASSETS_DIR="${ASSETS_DIR}"
DASH_SCRIPT="${DASH_DIR}/pyqt_dashboard_improved.py"

info(){ echo -e "\e[34m[INFO]\e[0m $*"; }
warn(){ echo -e "\e[33m[WARN]\e[0m $*" >&2; }

# Helper to start audio in background using available players
start_audio_bg(){
    local file="$1"
    if [ ! -f "$file" ]; then return 1; fi
    if command -v mpv >/dev/null 2>&1; then
        mpv --no-terminal --really-quiet "$file" &
        echo $!
    elif command -v ffplay >/dev/null 2>&1; then
        ffplay -nodisp -autoexit -loglevel quiet "$file" &
        echo $!
    elif command -v paplay >/dev/null 2>&1; then
        paplay "$file" &
        echo $!
    elif command -v aplay >/dev/null 2>&1; then
        # aplay is blocking, so run in background
        aplay "$file" &
        echo $!
    elif command -v ffmpeg >/dev/null 2>&1; then
        # use ffmpeg to play audio via ffplay-like behaviour
        ffmpeg -hide_banner -loglevel error -i "$file" -f alsa default &
        echo $!
    else
        warn "No compatible audio player found for $file"
        return 1
    fi
}

# Helper to play video (blocking) using mpv or ffplay
play_video(){
    local file="$1"
    if [ ! -f "$file" ]; then return 1; fi
    if command -v mpv >/dev/null 2>&1; then
        mpv --no-terminal --really-quiet --fullscreen "$file"
        return $?
    elif command -v ffplay >/dev/null 2>&1; then
        ffplay -autoexit -fs -loglevel quiet "$file"
        return $?
    else
        warn "No video player found for $file"
        return 1
    fi
}

# Show an image (blocking until killed) using ffplay/mpv or a small python fallback
show_image_blocking_bg(){
    local file="$1"
    if [ ! -f "$file" ]; then return 1; fi
    if command -v mpv >/dev/null 2>&1; then
        mpv --no-terminal --really-quiet --fullscreen --loop-file=inf "$file" &
        echo $!
    elif command -v ffplay >/dev/null 2>&1; then
        ffplay -loop 0 -loglevel quiet "$file" &
        echo $!
    elif command -v python3 >/dev/null 2>&1; then
        # Simple Tkinter display
        python3 - <<'XUI_HEREDOC_32' &
import sys, time
from PIL import Image, ImageTk
try:
    import tkinter as tk
    root = tk.Tk()
    root.attributes('-fullscreen', True)
    img = Image.open(sys.argv[1])
    w,h = root.winfo_screenwidth(), root.winfo_screenheight()
    img = img.resize((w,h), Image.LANCZOS)
    photo = ImageTk.PhotoImage(img)
    label = tk.Label(root, image=photo)
    label.pack()
    root.mainloop()
except Exception:
    pass
XUI_HEREDOC_32
        echo $!
    else
        warn "No method to show image $file"
        return 1
    fi
}

# Start startup audio in background if available
startup_audio_pid=0
if [ -f "$ASSETS_DIR/startup.mp3" ]; then
    pid=$(start_audio_bg "$ASSETS_DIR/startup.mp3" || true)
    startup_audio_pid=${pid:-0}
    if [ "$startup_audio_pid" -ne 0 ]; then
        info "Started startup audio (pid=$startup_audio_pid)"
    fi
fi

# Play startup video (blocking) if present
if [ -f "$ASSETS_DIR/startup.mp4" ]; then
    info "Playing startup video"
    play_video "$ASSETS_DIR/startup.mp4" || true
fi

# If the audio is still running after the video ends, show bootlogo.png until audio stops
if [ "$startup_audio_pid" -ne 0 ] && kill -0 "$startup_audio_pid" >/dev/null 2>&1; then
    if [ -f "$ASSETS_DIR/bootlogo.png" ]; then
        info "Displaying bootlogo while audio finishes"
        img_pid=$(show_image_blocking_bg "$ASSETS_DIR/bootlogo.png" || true)
        # Poll until audio process exits
        while kill -0 "$startup_audio_pid" >/dev/null 2>&1; do
            sleep 0.5
        done
        # kill image display
        if [ -n "${img_pid:-}" ] && kill -0 "$img_pid" >/dev/null 2>&1; then
            kill "$img_pid" || true
        fi
    else
        # no bootlogo available; just wait for audio to finish
        while kill -0 "$startup_audio_pid" >/dev/null 2>&1; do
            sleep 0.5
        done
    fi
fi

# Finally start the dashboard
info "Launching dashboard"
if command -v "$ASSETS_DIR/launcher" >/dev/null 2>&1; then
    exec "$ASSETS_DIR/launcher"
else
    exec /usr/bin/python3 "$DASH_SCRIPT"
fi
XUI_HEREDOC_31
chmod +x "$BIN_DIR/xui_startup_and_dashboard.sh"


# If startup media not provided, try to generate them from the embedded/copyed logo using ffmpeg (best-effort)
if [ ! -f "$ASSETS_DIR/startup.mp4" ] && command -v ffmpeg >/dev/null 2>&1 && [ -f "$ASSETS_DIR/logo.png" ]; then
    info "Generating $ASSETS_DIR/startup.mp4 from logo (ffmpeg detected)"
    ffmpeg -y -loop 1 -i "$ASSETS_DIR/logo.png" -c:v libx264 -t 3 -pix_fmt yuv420p "$ASSETS_DIR/startup.mp4" >/dev/null 2>&1 || warn "ffmpeg failed to generate startup.mp4"
fi

if [ ! -f "$ASSETS_DIR/startup.mp3" ] && command -v ffmpeg >/dev/null 2>&1; then
    info "Generating $ASSETS_DIR/startup.mp3 (3s sine tone)"
    ffmpeg -y -f lavfi -i "sine=frequency=440:duration=3" -c:a libmp3lame -q:a 4 "$ASSETS_DIR/startup.mp3" >/dev/null 2>&1 || warn "ffmpeg failed to generate startup.mp3"
fi
}

# Write embedded enable-autostart helper into $BIN_DIR
write_enable_autostart_script(){
        mkdir -p "$BIN_DIR"
        cat > "$BIN_DIR/xui_enable_autostart.sh" <<'XUI_HEREDOC_33'
#!/usr/bin/env bash
set -euo pipefail

# Installs autostart for XUI PyQt dashboard:
# - copies .desktop to ~/.config/autostart
# - installs systemd --user unit and enables it
# Run as the target user (not root). If you want system-wide boot before login you'll need a different approach.

XUI_HOME="$HOME/.xui"
AUTOSTART_DIR="$HOME/.config/autostart"
SYSTEMD_USER_DIR="$HOME/.config/systemd/user"
DESKTOP_FILE_NAME="xui-dashboard.desktop"
SERVICE_NAME="xui-gui.service"
PYQT_SCRIPT="$XUI_HOME/dashboard/pyqt_dashboard_improved.py"

mkdir -p "$AUTOSTART_DIR"
mkdir -p "$SYSTEMD_USER_DIR"

# Write .desktop (safe overwrite)
cat > "$AUTOSTART_DIR/$DESKTOP_FILE_NAME" <<'XUI_HEREDOC_34'
[Desktop Entry]
Type=Application
Name=XUI Dashboard
Comment=Start XUI fullscreen dashboard
Exec=python3 /home/$USER/.xui/dashboard/pyqt_dashboard_improved.py
Terminal=false
X-GNOME-Autostart-enabled=true
Hidden=false
NoDisplay=false
Categories=Utility;
XUI_HEREDOC_34

# Write systemd user service
cat > "$SYSTEMD_USER_DIR/$SERVICE_NAME" <<'XUI_HEREDOC_35'
[Unit]
Description=XUI GUI Dashboard (user service)
After=graphical-session.target

[Service]
Type=simple
ExecStart=/usr/bin/python3 $PYQT_SCRIPT
Restart=on-failure
Environment=DISPLAY=:0
Environment=XDG_RUNTIME_DIR=$XDG_RUNTIME_DIR

[Install]
WantedBy=default.target
XUI_HEREDOC_35

# Reload user systemd and enable service
systemctl --user daemon-reload
systemctl --user enable --now "$SERVICE_NAME" || {
    echo "Failed to enable systemd user service; you can enable it with: systemctl --user enable --now $SERVICE_NAME"
}

# Feedback
echo "Installed autostart .desktop to $AUTOSTART_DIR/$DESKTOP_FILE_NAME"
echo "Installed systemd user unit to $SYSTEMD_USER_DIR/$SERVICE_NAME (enabled)."

echo "Note: systemd user services run after you log in. If you want the GUI before login, configure auto-login or use a display-manager-level autostart."
XUI_HEREDOC_33
}

# -------------------------
# Additional utilities
# -------------------------
write_asset_generator(){
    info "Writing asset generator and PyQt prototype"
    mkdir -p "$BIN_DIR"
    cat > "$BIN_DIR/xui_gen_assets.py" <<'XUI_HEREDOC_36'
#!/usr/bin/env python3
import os
from PIL import Image, ImageDraw, ImageFont
XUI=os.path.expanduser('~/.xui')
ASSETS=os.path.join(XUI,'assets')
os.makedirs(ASSETS, exist_ok=True)
names = ['Casino','Runner','Store','Misiones','Perfil','Compat X86','LAN','Power Profile','Battery Saver']
for n in names:
    fn = os.path.join(ASSETS, f"{n}.png")
    if os.path.exists(fn):
        continue
    img = Image.new('RGB', (320,180), color=(12,84,166))
    d = ImageDraw.Draw(img)
    try:
        f = ImageFont.load_default()
    except Exception:
        f = None
    txt = n
    w,h = d.textsize(txt, font=f)
    d.text(((320-w)/2,(180-h)/2), txt, font=f, fill=(255,255,255))
    img.save(fn)
print('assets_generated')
XUI_HEREDOC_36
    chmod +x "$BIN_DIR/xui_gen_assets.py"

    cat > "$DASH_DIR/pyqt_dashboard.py" <<'XUI_HEREDOC_37'
#!/usr/bin/env python3
import sys, os
from pathlib import Path
ASSETS = Path.home()/'.xui'/'assets'
try:
    from PyQt5 import QtWidgets, QtGui, QtCore
except Exception:
    print('PyQt5 not installed')
    sys.exit(1)


class TileWidget(QtWidgets.QFrame):
    def __init__(self, name, img_path=None, parent=None, big=False):
        super().__init__(parent)
        self.name = name
        # Prefer explicit img_path; if missing, fall back to applogo.png in assets
        if img_path:
            self.img_path = img_path
        else:
            fallback = ASSETS / 'applogo.png'
            self.img_path = fallback if fallback.exists() else None
        self.big = big
        self.setObjectName('tile')
        self.setFocusPolicy(QtCore.Qt.StrongFocus)
        self.setStyleSheet(self.default_style())
        v = QtWidgets.QVBoxLayout(self)
        self.img_label = QtWidgets.QLabel()
        self.img_label.setAlignment(QtCore.Qt.AlignCenter)
        if img_path and img_path.exists():
            pix = QtGui.QPixmap(str(img_path)).scaled(400 if big else 220, 220 if big else 120, QtCore.Qt.KeepAspectRatio, QtCore.Qt.SmoothTransformation)
            self.img_label.setPixmap(pix)
        else:
            self.img_label.setText('')
            self.img_label.setFixedHeight(180 if big else 100)
        self.title = QtWidgets.QLabel(name)
        self.title.setAlignment(QtCore.Qt.AlignCenter)
        self.title.setStyleSheet('color:white;')
        v.addWidget(self.img_label)
        v.addWidget(self.title)
        self.anim = QtCore.QPropertyAnimation(self, b"geometry")

    def default_style(self):
        return "QFrame#tile { background: #0C54A6; border: 2px solid #08375a; border-radius:8px; } QLabel { color: white; }"

    def focusInEvent(self, e):
        # zoom animation
        rect = self.geometry()
        self.anim.stop()
        self.anim.setDuration(160)
        self.anim.setStartValue(rect)
        self.anim.setEndValue(QtCore.QRect(rect.x()-6, rect.y()-6, rect.width()+12, rect.height()+12))
        self.anim.start()
        self.setStyleSheet("QFrame#tile { background: #1E90FF; border: 3px solid #00FFFF; border-radius:8px; } QLabel { color: white; font-weight: bold; }")
        super().focusInEvent(e)

    def focusOutEvent(self, e):
        self.anim.stop()
        rect = self.geometry()
        self.anim.setDuration(120)
        self.anim.setStartValue(rect)
        self.anim.setEndValue(QtCore.QRect(rect.x()+6, rect.y()+6, rect.width()-12, rect.height()-12))
        self.anim.start()
        self.setStyleSheet(self.default_style())
        super().focusOutEvent(e)

    def mousePressEvent(self, e):
        # route to main window handlers when possible
        win = QtWidgets.QApplication.activeWindow()
        if win and hasattr(win, 'on_tile_clicked'):
            win.on_tile_clicked(self.name)
        else:
            super().mousePressEvent(e)

    def clicked(self):
        # map name to action
        xui = os.path.expanduser('~/.xui')
        mapping = {
            'Casino': ['python3', os.path.join(xui,'casino','casino.py')],
            'Runner': ['python3', os.path.join(xui,'games','runner.py')],
            'Store': ['bash', os.path.join(xui,'bin','xui_store.sh')],
            'LAN': ['bash', '-c', 'ip -4 addr show | sed -n "1,20p"; read -p "Press ENTER"'],
            'Power Profile': ['bash', os.path.join(xui,'bin','xui_battery_profile.sh'), 'balanced'],
            'Battery Saver': ['bash', os.path.join(xui,'bin','xui_battery_saver.sh'), 'toggle'],
        }
        cmd = mapping.get(self.name)
        if cmd:
            try:
                QtCore.QProcess.startDetached(cmd[0], cmd[1:])
            except Exception:
                pass


class MainWindow(QtWidgets.QMainWindow):
    def __init__(self):
        super().__init__()
        self.setWindowTitle('XUI GUI - Xbox Style')
        central = QtWidgets.QWidget()
        main_l = QtWidgets.QHBoxLayout(central)
        # left panel
        left = QtWidgets.QVBoxLayout()
        user_lbl = QtWidgets.QLabel('Usuario')
        user_lbl.setStyleSheet('color:white; font-weight:bold;')
        left.addWidget(user_lbl)
        left.addSpacing(10)
        # quick tiles on left column
        left_tiles = ['Perfil','Compat X86']
        for t in left_tiles:
            lbl = QtWidgets.QLabel(t)
            lbl.setStyleSheet('background:#0C54A6; color:white; padding:8px; border-radius:6px;')
            lbl.setFixedHeight(48)
            left.addWidget(lbl)
            left.addSpacing(6)
        left.addStretch()
        left_widget = QtWidgets.QFrame()
        left_widget.setLayout(left)
        left_widget.setFixedWidth(180)
        left_widget.setStyleSheet('background: #000;')

        # center: hero + tiles
        center = QtWidgets.QWidget()
        grid = QtWidgets.QGridLayout(center)
        # hero tile spans two rows and two columns
        names = ['Casino','Runner','Store','Misiones','LAN','Power Profile','Battery Saver']
        hero = TileWidget('Casino', ASSETS/'Casino.png', big=True)
        grid.addWidget(hero, 0, 0, 2, 2)
        others = ['Runner','Store','Misiones','LAN','Power Profile','Battery Saver']
        positions = [(0,2),(1,2),(2,0),(2,1),(2,2),(3,0)]
        idx = 0
        self.tiles = [hero]
        for name,pos in zip(others, positions):
            img_webp = ASSETS/(f"{name}.webp")
            img_png = ASSETS/(f"{name}.png")
            img = img_webp if img_webp.exists() else (img_png if img_png.exists() else None)
            tw = TileWidget(name, img if img is not None else None, big=False)
            grid.addWidget(tw, pos[0], pos[1])
            self.tiles.append(tw)

        # right column: featured list
        right = QtWidgets.QVBoxLayout()
        right_title = QtWidgets.QLabel('Featured')
        right_title.setStyleSheet('color:white; font-weight:bold')
        right.addWidget(right_title)
        for i in range(4):
            lbl = QtWidgets.QLabel(f'Featured {i+1}')
            lbl.setFixedHeight(70)
            lbl.setStyleSheet('background:#111; color:white; border:1px solid #333; padding:6px;')
            right.addWidget(lbl)
            right.addSpacing(8)
        right.addStretch()
        right_widget = QtWidgets.QFrame()
        right_widget.setLayout(right)
        right_widget.setFixedWidth(240)

        main_l.addWidget(left_widget)
        main_l.addWidget(center, 1)
        main_l.addWidget(right_widget)

        self.setCentralWidget(central)
        self.current_index = 0
        QtCore.QTimer.singleShot(120, self.update_focus)

    def update_focus(self):
        if 0 <= self.current_index < len(self.tiles):
            self.tiles[self.current_index].setFocus()

    def keyPressEvent(self, e):
        key = e.key()
        cols = 3
        r = self.current_index // cols
        c = self.current_index % cols
        if key == QtCore.Qt.Key_Left:
            c = max(0, c-1)
        elif key == QtCore.Qt.Key_Right:
            c = min(cols-1, c+1)
        elif key == QtCore.Qt.Key_Up:
            r = max(0, r-1)
        elif key == QtCore.Qt.Key_Down:
            r = min(3, r+1)
        elif key == QtCore.Qt.Key_Return or key == QtCore.Qt.Key_Enter:
            self.tiles[self.current_index].clicked()
            return
        else:
            super().keyPressEvent(e)
            return
        new_index = r*cols + c
        new_index = max(0, min(new_index, len(self.tiles)-1))
        self.current_index = new_index
        self.update_focus()

if __name__=='__main__':
    app = QtWidgets.QApplication(sys.argv)
    w = MainWindow()
    w.resize(1200,720)
    w.show()
    sys.exit(app.exec_())
XUI_HEREDOC_37
    chmod +x "$DASH_DIR/pyqt_dashboard.py"
}

post_create_assets(){
    # ensure generator exists
    write_asset_generator
    # run python generator; install Pillow if allowed and missing
    if python3 - <<'XUI_HEREDOC_38' >/dev/null 2>&1
try:
    from PIL import Image
    print('ok')
except Exception:
    raise SystemExit(2)
XUI_HEREDOC_38
    then
        python3 "$BIN_DIR/xui_gen_assets.py" || true
    else
        if [ "$XUI_INSTALL_SYSTEM" = "1" ]; then
            info "Pillow missing, attempting to install"
            pip_install Pillow || warn "Could not install Pillow; assets may not be generated"
            python3 "$BIN_DIR/xui_gen_assets.py" || true
        else
            warn "Pillow not available; run installer with --yes-install to auto-install and generate assets"
        fi
    fi
}
write_logger_and_helpers(){
    info "Writing logger helper and log rotate script"
    cat > "$BIN_DIR/xui_log.sh" <<'XUI_HEREDOC_39'
#!/usr/bin/env bash
LOG="$HOME/.xui/logs/xui.log"
mkdir -p "$(dirname "$LOG")"
msg="$*"
ts=$(date --iso-8601=seconds)
echo "$ts $msg" >> "$LOG"
XUI_HEREDOC_39
    chmod +x "$BIN_DIR/xui_log.sh"

    # simple logrotate helper
    cat > "$BIN_DIR/xui_log_rotate.sh" <<'XUI_HEREDOC_40'
#!/usr/bin/env bash
LOGDIR="$HOME/.xui/logs"
mkdir -p "$LOGDIR"
find "$LOGDIR" -name '*.log' -type f -size +100k -exec gzip -9 {} \; || true
XUI_HEREDOC_40
    chmod +x "$BIN_DIR/xui_log_rotate.sh"
}

write_backup_restore(){
    info "Writing backup and restore scripts"
    cat > "$BIN_DIR/xui_backup.sh" <<'XUI_HEREDOC_41'
#!/usr/bin/env bash
set -euo pipefail
DST="$HOME/.xui/backups/xui-backup-$(date +%Y%m%d-%H%M%S).tar.gz"
mkdir -p "$HOME/.xui/backups"
tar -czf "$DST" -C "$HOME/.xui" data bin dashboard casino games assets || true
echo "$DST"
XUI_HEREDOC_41
    chmod +x "$BIN_DIR/xui_backup.sh"

    cat > "$BIN_DIR/xui_restore.sh" <<'XUI_HEREDOC_42'
#!/usr/bin/env bash
set -euo pipefail
ARCH=${1:-}
if [ -z "$ARCH" ]; then echo "Usage: $0 <backup-archive>"; exit 1; fi
tar -xzf "$ARCH" -C "$HOME/.xui" || { echo "Restore failed"; exit 1; }
echo "Restored from $ARCH"
XUI_HEREDOC_42
    chmod +x "$BIN_DIR/xui_restore.sh"
}

write_diagnostics(){
    info "Writing diagnostics script"
    cat > "$BIN_DIR/xui_diag.sh" <<'XUI_HEREDOC_43'
#!/usr/bin/env bash
set -euo pipefail
echo "XUI Diagnostics"
echo "Date: $(date)"
echo "User: $USER"
echo "OS: $(lsb_release -ds 2>/dev/null || uname -a)"
echo "Disk usage:"; df -h /
echo "Memory:"; free -h
echo "Processes (top 5):"; ps aux --sort=-%mem | head -n 6
echo "Installed: box64=$(command -v box64 >/dev/null 2>&1 && echo yes || echo no) fex=$(command -v fex >/dev/null 2>&1 && echo yes || echo no)"
echo "Python libs:"; python3 -c "import pkgutil;print([m.name for m in pkgutil.iter_modules() if m.name in ('urwid','evdev')])" 2>/dev/null || true
XUI_HEREDOC_43
    chmod +x "$BIN_DIR/xui_diag.sh"
}

write_profiles_manager(){
    info "Writing simple profiles manager"
    mkdir -p "$DATA_DIR/profiles"
    cat > "$BIN_DIR/xui_profile.sh" <<'XUI_HEREDOC_44'
#!/usr/bin/env bash
set -euo pipefail
PROFDIR="$HOME/.xui/data/profiles"
mkdir -p "$PROFDIR"
case ${1:-list} in
    list) ls -1 "$PROFDIR" || echo "no profiles"; ;;
    save)
        name=${2:-default}
        tar -czf "$PROFDIR/$name.tgz" -C "$HOME/.xui" data || echo saved
        ;;
    restore)
        file=$2
        tar -xzf "$file" -C "$HOME/.xui" || echo restored
        ;;
    *) echo "Usage: $0 {list|save <name>|restore <file>}"; exit 1;;
esac
XUI_HEREDOC_44
    chmod +x "$BIN_DIR/xui_profile.sh"
}

write_plugins_skeleton(){
    info "Writing plugin skeleton and loader"
    mkdir -p "$XUI_DIR/plugins"
    cat > "$XUI_DIR/plugins/README.md" <<'XUI_HEREDOC_45'
XUI plugins: drop executable Python scripts here. The Dashboard may load plugins by launching them.
XUI_HEREDOC_45
    cat > "$BIN_DIR/xui_plugin_mgr.sh" <<'XUI_HEREDOC_46'
#!/usr/bin/env bash
PLUGDIR="$HOME/.xui/plugins"
case ${1:-list} in
    list) ls -1 "$PLUGDIR" || echo none;;
    run)
        for f in "$PLUGDIR"/*; do [ -x "$f" ] && "$f" || true; done
        ;;
    *) echo "Usage: $0 {list|run}"; exit 1;;
esac
XUI_HEREDOC_46
    chmod +x "$BIN_DIR/xui_plugin_mgr.sh"
}

write_auto_update(){
    info "Writing auto-update checker (GitHub releases)"
    cat > "$BIN_DIR/xui_update_check.sh" <<'XUI_HEREDOC_47'
#!/usr/bin/env bash
REPO="youruser/xui-repo" # set to upstream
echo "Checking updates for $REPO..."
if command -v curl >/dev/null 2>&1; then
    TAG=$(curl -sS https://api.github.com/repos/$REPO/releases/latest | jq -r .tag_name)
    echo "Latest: $TAG"
else
    echo "curl required"; exit 1
fi
XUI_HEREDOC_47
    chmod +x "$BIN_DIR/xui_update_check.sh"
}

write_uninstall(){
    info "Writing uninstall script"
    cat > "$BIN_DIR/xui_uninstall.sh" <<'XUI_HEREDOC_48'
#!/usr/bin/env bash
set -euo pipefail
read -p "This will remove ~/.xui (files only). Continue? [s/N] " r
case "$r" in [sS]) rm -rf "$HOME/.xui"; echo removed;; *) echo aborted; exit 1;; esac
XUI_HEREDOC_48
    chmod +x "$BIN_DIR/xui_uninstall.sh"
}

write_readme_and_requirements(){
    info "Writing README and requirements"
    cat > "$XUI_DIR/README.md" <<'XUI_HEREDOC_49'
XUI 4.0XV - Ultra Master Installer
Files installed under ~/.xui
Use systemctl --user to enable services
XUI_HEREDOC_49
    cat > "$XUI_DIR/requirements.txt" <<'XUI_HEREDOC_50'
urwid
evdev
XUI_HEREDOC_50
}

write_basic_tests(){
    info "Writing basic tests"
    mkdir -p "$XUI_DIR/tests"
    cat > "$XUI_DIR/tests/test_balance.py" <<'XUI_HEREDOC_51'
import json, os
f=os.path.expanduser('~/.xui/data/saldo.json')
def test_balance_exists():
        assert os.path.exists(f)
        d=json.load(open(f))
        assert 'balance' in d
XUI_HEREDOC_51
}

write_apps_utilities(){
    info "Writing utilities and lightweight apps"
    # Screenshot utility
    cat > "$BIN_DIR/xui_screenshot.sh" <<'XUI_HEREDOC_52'
#!/usr/bin/env bash
set -euo pipefail
OUT="$HOME/.xui/assets/screenshot-$(date +%Y%m%d-%H%M%S).png"
mkdir -p "$(dirname "$OUT")"
if command -v maim >/dev/null 2>&1; then
    maim "$OUT"
elif command -v scrot >/dev/null 2>&1; then
    scrot "$OUT"
else
    echo "No screenshot tool installed"
    exit 1
fi
echo "$OUT"
XUI_HEREDOC_52
    chmod +x "$BIN_DIR/xui_screenshot.sh"

    # System monitor (top-like summary)
    cat > "$BIN_DIR/xui_sysmon.sh" <<'XUI_HEREDOC_53'
#!/usr/bin/env bash
htop || top -b -n1 | head -n 20
XUI_HEREDOC_53
    chmod +x "$BIN_DIR/xui_sysmon.sh"

    # Quick browser launcher
    cat > "$BIN_DIR/xui_browser.sh" <<'XUI_HEREDOC_54'
#!/usr/bin/env bash
# xui_browser.sh - launcher with kiosk support and fallback to text browser
MODE=normal
URL=${1:-}
if [ "$1" = "--kiosk" ]; then MODE=kiosk; shift; URL=${1:-}
fi
if [ -z "$URL" ]; then URL="about:blank"; fi
if command -v firefox >/dev/null 2>&1; then
    if [ "$MODE" = "kiosk" ]; then
        firefox --kiosk "$URL" &
    else
        firefox "$URL" &
    fi
elif command -v chromium-browser >/dev/null 2>&1; then
    if [ "$MODE" = "kiosk" ]; then
        chromium-browser --kiosk "$URL" &
    else
        chromium-browser "$URL" &
    fi
elif command -v chromium >/dev/null 2>&1; then
    if [ "$MODE" = "kiosk" ]; then
        chromium --kiosk "$URL" &
    else
        chromium "$URL" &
    fi
elif command -v x-www-browser >/dev/null 2>&1; then
    x-www-browser "$URL" &
elif command -v w3m >/dev/null 2>&1; then
    # text-mode browser fallback
    exec w3m "$URL"
else
    echo "No browser found. Install Firefox/Chromium or w3m." >&2
    exit 1
fi
XUI_HEREDOC_54
    chmod +x "$BIN_DIR/xui_browser.sh"

    # Quick notes
    cat > "$BIN_DIR/xui_note.sh" <<'XUI_HEREDOC_55'
#!/usr/bin/env bash
NOTES="$HOME/.xui/data/notes.txt"
mkdir -p "$(dirname "$NOTES")"
${EDITOR:-nano} "$NOTES"
XUI_HEREDOC_55
    chmod +x "$BIN_DIR/xui_note.sh"

    # Music player (simple)
    cat > "$BIN_DIR/xui_music.sh" <<'XUI_HEREDOC_56'
#!/usr/bin/env bash
MUSIC_DIR="$HOME/Music"
if [ -n "$1" ]; then
    FILE="$1"
else
    FILE=$(find "$MUSIC_DIR" -type f -iname '*.mp3' | head -n1 || true)
fi
if [ -z "$FILE" ]; then echo "No music file"; exit 1; fi
if command -v mpv >/dev/null 2>&1; then mpv "$FILE"; elif command -v vlc >/dev/null 2>&1; then vlc --play-and-exit "$FILE"; else echo "No player"; exit 1; fi
XUI_HEREDOC_56
    chmod +x "$BIN_DIR/xui_music.sh"

    # Brightness helper (requires sysfs)
    cat > "$BIN_DIR/xui_brightness.sh" <<'XUI_HEREDOC_57'
#!/usr/bin/env bash
VAL=${1:-}
DEV="/sys/class/backlight"
if [ -z "$VAL" ]; then echo "Usage: $0 <percent|up|down>"; exit 1; fi
if [ "$VAL" = "up" ]; then VAL=10; mode=add; elif [ "$VAL" = "down" ]; then VAL=10; mode=sub; fi
echo "Brightness helper not implemented for all devices"; exit 0
XUI_HEREDOC_57
    chmod +x "$BIN_DIR/xui_brightness.sh"

    # Volume control helper
    cat > "$BIN_DIR/xui_volume.sh" <<'XUI_HEREDOC_58'
#!/usr/bin/env bash
case ${1:-} in
    up) pactl set-sink-volume @DEFAULT_SINK@ +5% ;; 
    down) pactl set-sink-volume @DEFAULT_SINK@ -5% ;; 
    mute) pactl set-sink-mute @DEFAULT_SINK@ toggle ;; 
    *) pactl list sinks | grep -E "Name:|Volume:|Mute:" -A2 ;;
esac
XUI_HEREDOC_58
    chmod +x "$BIN_DIR/xui_volume.sh"

    # Simple HTTP server
    cat > "$BIN_DIR/xui_http_server.sh" <<'XUI_HEREDOC_59'
#!/usr/bin/env bash
PORT=${1:-8000}
DIR=${2:-$HOME}
cd "$DIR"
python3 -m http.server "$PORT"
XUI_HEREDOC_59
    chmod +x "$BIN_DIR/xui_http_server.sh"

    # SSH toggle
    cat > "$BIN_DIR/xui_ssh_toggle.sh" <<'XUI_HEREDOC_60'
#!/usr/bin/env bash
if systemctl --user is-enabled ssh.service >/dev/null 2>&1; then
    systemctl --user stop ssh.service || true
    echo "ssh stopped"
else
    systemctl --user start ssh.service || true
    echo "ssh started"
fi
XUI_HEREDOC_60
    chmod +x "$BIN_DIR/xui_ssh_toggle.sh"

    # Create desktop entries for some utilities
    cat > "$AUTOSTART_DIR/xui-sysmon.desktop" <<'XUI_HEREDOC_61'
[Desktop Entry]
Type=Application
Name=XUI System Monitor
Exec=$BIN_DIR/xui_sysmon.sh
Terminal=true
XUI_HEREDOC_61
}

write_more_apps(){
        info "Writing additional apps: file manager, gallery, wifi/bluetooth toggles, gamepad test, calc, updater, retroarch launcher"

        # File manager launcher
        cat > "$BIN_DIR/xui_filemgr.sh" <<'XUI_HEREDOC_62'
#!/usr/bin/env bash
if command -v dolphin >/dev/null 2>&1; then
    dolphin "$@" &
elif command -v pcmanfm >/dev/null 2>&1; then
    pcmanfm "$@" &
elif command -v thunar >/dev/null 2>&1; then
    thunar "$@" &
else
    echo "No file manager found"; exit 1
fi
XUI_HEREDOC_62
        chmod +x "$BIN_DIR/xui_filemgr.sh"

        # Gallery viewer
        cat > "$BIN_DIR/xui_gallery.sh" <<'XUI_HEREDOC_63'
#!/usr/bin/env bash
DIR=${1:-$HOME/Pictures}
IMG=$(find "$DIR" -type f \( -iname '*.png' -o -iname '*.jpg' -o -iname '*.jpeg' \) | head -n1 || true)
if [ -z "$IMG" ]; then echo "No images found"; exit 1; fi
if command -v feh >/dev/null 2>&1; then feh -F "$DIR"; elif command -v sxiv >/dev/null 2>&1; then sxiv "$DIR"; elif command -v display >/dev/null 2>&1; then display "$IMG"; else echo "No image viewer installed"; exit 1; fi
XUI_HEREDOC_63
        chmod +x "$BIN_DIR/xui_gallery.sh"

        # WiFi toggle
        cat > "$BIN_DIR/xui_wifi_toggle.sh" <<'XUI_HEREDOC_64'
#!/usr/bin/env bash
if command -v nmcli >/dev/null 2>&1; then
    STATE=$(nmcli radio wifi)
    if [ "$STATE" = "enabled" ]; then nmcli radio wifi off; echo "wifi off"; else nmcli radio wifi on; echo "wifi on"; fi
else
    echo "nmcli not available"; exit 1
fi
XUI_HEREDOC_64
        chmod +x "$BIN_DIR/xui_wifi_toggle.sh"

        # Bluetooth toggle
        cat > "$BIN_DIR/xui_bluetooth_toggle.sh" <<'XUI_HEREDOC_65'
#!/usr/bin/env bash
if command -v bluetoothctl >/dev/null 2>&1; then
    POWER=$(bluetoothctl show | grep Powered | awk '{print $2}')
    if [ "$POWER" = "yes" ]; then bluetoothctl power off; echo "bluetooth off"; else bluetoothctl power on; echo "bluetooth on"; fi
else
    echo "bluetoothctl not found"; exit 1
fi
XUI_HEREDOC_65
        chmod +x "$BIN_DIR/xui_bluetooth_toggle.sh"

        # Gamepad test launcher
        cat > "$BIN_DIR/xui_gamepad_test.sh" <<'XUI_HEREDOC_66'
#!/usr/bin/env bash
if command -v jstest-gtk >/dev/null 2>&1; then jstest-gtk & elif command -v evtest >/dev/null 2>&1; then sudo evtest; else echo "No gamepad tester installed"; exit 1; fi
XUI_HEREDOC_66
        chmod +x "$BIN_DIR/xui_gamepad_test.sh"

        # Calculator
        cat > "$BIN_DIR/xui_calc.sh" <<'XUI_HEREDOC_67'
#!/usr/bin/env bash
if command -v gcalctool >/dev/null 2>&1; then gcalctool & else xterm -e bc -l; fi
XUI_HEREDOC_67
        chmod +x "$BIN_DIR/xui_calc.sh"

        # System updater wrapper
        cat > "$BIN_DIR/xui_update_system.sh" <<'XUI_HEREDOC_68'
#!/usr/bin/env bash
if [ "${XUI_INSTALL_SYSTEM:-0}" != "1" ]; then echo "Run installer with --yes-install to allow system updates"; exit 1; fi
sudo apt update && sudo apt upgrade -y
XUI_HEREDOC_68
        chmod +x "$BIN_DIR/xui_update_system.sh"

        # RetroArch launcher
        cat > "$BIN_DIR/xui_retroarch.sh" <<'XUI_HEREDOC_69'
#!/usr/bin/env bash
if command -v retroarch >/dev/null 2>&1; then retroarch "$@"; else echo "retroarch not found"; exit 1; fi
XUI_HEREDOC_69
        chmod +x "$BIN_DIR/xui_retroarch.sh"
}

write_even_more_apps(){
        info "Writing extra utilities: screenrec, clipboard, rclone backup, torrent, kodi, wallpaper, cron helper, emoji picker"

        # Screen recorder using ffmpeg
        cat > "$BIN_DIR/xui_screenrec.sh" <<'XUI_HEREDOC_70'
#!/usr/bin/env bash
OUT_DIR="$HOME/.xui/assets/records"
mkdir -p "$OUT_DIR"
OUT="$OUT_DIR/rec-$(date +%Y%m%d-%H%M%S).mkv"
FPS=${1:-25}
if command -v ffmpeg >/dev/null 2>&1; then
    ffmpeg -video_size $(xdpyinfo | grep dimensions | awk '{print $2}') -framerate $FPS -f x11grab $DISPLAY -i ${DISPLAY:-:0} -f pulse -i default "$OUT"
    echo "$OUT"
else
    echo "ffmpeg not installed"; exit 1
fi
XUI_HEREDOC_70
        chmod +x "$BIN_DIR/xui_screenrec.sh"

        # Clipboard manager wrapper (xclip/xsel)
        cat > "$BIN_DIR/xui_clip.sh" <<'XUI_HEREDOC_71'
#!/usr/bin/env bash
case ${1:-get} in
    get)
        if command -v xclip >/dev/null 2>&1; then xclip -o -selection clipboard; elif command -v xsel >/dev/null 2>&1; then xsel --clipboard --output; else echo; fi
        ;;
    set)
        shift
        TEXT="$*"
        if command -v xclip >/dev/null 2>&1; then printf "%s" "$TEXT" | xclip -selection clipboard; elif command -v xsel >/dev/null 2>&1; then printf "%s" "$TEXT" | xsel --clipboard --input; else echo "no clipboard tool"; exit 1; fi
        ;;
    *) echo "Usage: $0 {get|set <text>}"; exit 1;;
esac
XUI_HEREDOC_71
        chmod +x "$BIN_DIR/xui_clip.sh"

        # rclone backup wrapper
        cat > "$BIN_DIR/xui_rclone_backup.sh" <<'XUI_HEREDOC_72'
#!/usr/bin/env bash
DEST=${1:-remote:backups}
SRC="$HOME/.xui"
if command -v rclone >/dev/null 2>&1; then
    rclone sync "$SRC" "$DEST" --progress
else
    echo "rclone not installed"; exit 1
fi
XUI_HEREDOC_72
        chmod +x "$BIN_DIR/xui_rclone_backup.sh"

        # Torrent client launcher
        cat > "$BIN_DIR/xui_torrent.sh" <<'XUI_HEREDOC_73'
#!/usr/bin/env bash
if command -v transmission-gtk >/dev/null 2>&1; then transmission-gtk "$@" & elif command -v qbittorrent >/dev/null 2>&1; then qbittorrent "$@" & else echo "No torrent client installed"; exit 1; fi
XUI_HEREDOC_73
        chmod +x "$BIN_DIR/xui_torrent.sh"

        # Kodi launcher
        cat > "$BIN_DIR/xui_kodi.sh" <<'XUI_HEREDOC_74'
#!/usr/bin/env bash
if command -v kodi >/dev/null 2>&1; then kodi "$@" & else echo "kodi not installed"; exit 1; fi
XUI_HEREDOC_74
        chmod +x "$BIN_DIR/xui_kodi.sh"

        # Wallpaper setter (feh)
        cat > "$BIN_DIR/xui_wallpaper.sh" <<'XUI_HEREDOC_75'
#!/usr/bin/env bash
IMG=${1:-}
if [ -z "$IMG" ]; then echo "Usage: $0 <image>"; exit 1; fi
if command -v feh >/dev/null 2>&1; then feh --bg-scale "$IMG"; else echo "feh not installed"; exit 1; fi
XUI_HEREDOC_75
        chmod +x "$BIN_DIR/xui_wallpaper.sh"

        # Cron helper - list and edit user crontab
        cat > "$BIN_DIR/xui_cron.sh" <<'XUI_HEREDOC_76'
#!/usr/bin/env bash
case ${1:-list} in
    list) crontab -l || echo "no crontab" ;;
    edit) crontab -e ;;
    *) echo "Usage: $0 {list|edit}"; exit 1;;
esac
XUI_HEREDOC_76
        chmod +x "$BIN_DIR/xui_cron.sh"

        # Emoji picker via rofi (clipboard)
        cat > "$BIN_DIR/xui_emoji.sh" <<'XUI_HEREDOC_77'
#!/usr/bin/env bash
EMOJI_FILE="$HOME/.xui/data/emoji.txt"
mkdir -p "$(dirname "$EMOJI_FILE")"
[ -f "$EMOJI_FILE" ] || cat > "$EMOJI_FILE" <<'XUI_HEREDOC_78'
üòÄ
üéÆ
üî•
üíæ
üéµ
XUI_HEREDOC_78
if command -v rofi >/dev/null 2>&1; then
    CH=$(cat "$EMOJI_FILE" | rofi -dmenu -p emoji)
    if [ -n "$CH" ]; then printf "%s" "$CH" | xclip -selection clipboard; fi
else
    echo "Install rofi to use emoji picker"; exit 1
fi
XUI_HEREDOC_77
        chmod +x "$BIN_DIR/xui_emoji.sh"
}

write_battery_tools(){
        info "Writing battery saver, info, profiles and monitor"

        # Battery saver: reduce frequencies, dim audio, disable wifi/bluetooth
        cat > "$BIN_DIR/xui_battery_saver.sh" <<'XUI_HEREDOC_79'
#!/usr/bin/env bash
set -euo pipefail
ACTION=${1:-enable}
STATE_FILE="$HOME/.xui/data/battery_saver_on"

set_cpu_max(){
    val="$1"
    # prefer cpupower if available
    if command -v cpupower >/dev/null 2>&1; then
        cpupower frequency-set -u "${val}Hz" >/dev/null 2>&1 || true
        return
    fi
    for cpu in /sys/devices/system/cpu/cpu[0-9]*; do
        f="$cpu/cpufreq/scaling_max_freq"
        if [ -f "$f" ]; then
            if [ -w "$f" ]; then
                echo "$val" > "$f" || true
            else
                sudo sh -c "echo $val > $f" 2>/dev/null || true
            fi
        fi
    done
}

set_brightness_pct(){
    pct=${1:-25}
    # try brightnessctl, xbacklight, sysfs
    if command -v brightnessctl >/dev/null 2>&1; then
        brightnessctl set ${pct}% >/dev/null 2>&1 || true
        return
    fi
    if command -v xbacklight >/dev/null 2>&1; then
        xbacklight -set $pct >/dev/null 2>&1 || true
        return
    fi
    for d in /sys/class/backlight/*; do
        if [ -f "$d/brightness" ] && [ -f "$d/max_brightness" ]; then
            max=$(cat "$d/max_brightness")
            val=$((max * pct / 100))
            if [ -w "$d/brightness" ]; then
                echo "$val" > "$d/brightness" || true
            else
                sudo sh -c "echo $val > $d/brightness" 2>/dev/null || true
            fi
        fi
    done
}

mute_audio(){
    if command -v pactl >/dev/null 2>&1; then
        pactl set-sink-mute @DEFAULT_SINK@ 1 2>/dev/null || true
    elif command -v amixer >/dev/null 2>&1; then
        amixer -D pulse sset Master mute >/dev/null 2>&1 || true
    fi
}

unmute_audio(){
    if command -v pactl >/dev/null 2>&1; then
        pactl set-sink-mute @DEFAULT_SINK@ 0 2>/dev/null || true
    elif command -v amixer >/dev/null 2>&1; then
        amixer -D pulse sset Master unmute >/dev/null 2>&1 || true
    fi
}

disable_net_bt(){
    if command -v nmcli >/dev/null 2>&1; then nmcli radio wifi off >/dev/null 2>&1 || true; fi
    if command -v bluetoothctl >/dev/null 2>&1; then bluetoothctl power off >/dev/null 2>&1 || true; fi
}

enable_net_bt(){
    if command -v nmcli >/dev/null 2>&1; then nmcli radio wifi on >/dev/null 2>&1 || true; fi
    if command -v bluetoothctl >/dev/null 2>&1; then bluetoothctl power on >/dev/null 2>&1 || true; fi
}

case "$ACTION" in
    enable)
        mkdir -p "$(dirname "$STATE_FILE")"
        set_cpu_max 300000 || true
        set_brightness_pct 25 || true
        mute_audio || true
        disable_net_bt || true
        touch "$STATE_FILE" || true
        echo "Battery saver enabled"
        ;;
    disable)
        set_cpu_max 0 || true
        set_brightness_pct 85 || true
        unmute_audio || true
        enable_net_bt || true
        rm -f "$STATE_FILE" || true
        echo "Battery saver disabled"
        ;;
    toggle)
        if [ -f "$STATE_FILE" ]; then exec "$0" disable; else exec "$0" enable; fi
        ;;
    *) echo "Usage: $0 {enable|disable|toggle}"; exit 1;;
esac
XUI_HEREDOC_79
        chmod +x "$BIN_DIR/xui_battery_saver.sh"

        # Battery info: show capacity, status and power/voltage if available
        cat > "$BIN_DIR/xui_battery_info.sh" <<'XUI_HEREDOC_80'
#!/usr/bin/env bash
set -euo pipefail
if command -v upower >/dev/null 2>&1; then
    upower -e | while read -r dev; do
        upower -i "$dev" | awk '/percentage|state|voltage|time to/{print}'
    done
    exit 0
fi
for s in /sys/class/power_supply/*; do
    [ -d "$s" ] || continue
    name=$(basename "$s")
    if [ -f "$s/capacity" ]; then
        cap=$(cat "$s/capacity")
        stat=$(cat "$s/status" 2>/dev/null || echo Unknown)
        echo "$name: $cap% ($stat)"
    fi
    if [ -f "$s/voltage_now" ]; then
        v=$(cat "$s/voltage_now")
        echo "$name voltage: $v" 
    fi
done
XUI_HEREDOC_80
        chmod +x "$BIN_DIR/xui_battery_info.sh"

        # Battery profiles: eco, balanced, performance
        cat > "$BIN_DIR/xui_battery_profile.sh" <<'XUI_HEREDOC_81'
#!/usr/bin/env bash
set -euo pipefail
PROFILE=${1:-balanced}
write_profile(){ echo "$1" > "$HOME/.xui/data/battery_profile" 2>/dev/null || true }
case "$PROFILE" in
    eco)
        # minimal
        setval=300000
        ;;
    balanced)
        setval=1150000
        ;;
    performance)
        # try to use maxfreq from CPU0
        if [ -f /sys/devices/system/cpu/cpu0/cpufreq/cpuinfo_max_freq ]; then
            setval=$(cat /sys/devices/system/cpu/cpu0/cpufreq/cpuinfo_max_freq)
        else
            setval=0
        fi
        ;;
    *) echo "Usage: $0 {eco|balanced|performance}"; exit 1;;
esac
if [ "$setval" -ne 0 ]; then
    if command -v cpupower >/dev/null 2>&1; then
        cpupower frequency-set -u "${setval}Hz" >/dev/null 2>&1 || true
    else
        for cpu in /sys/devices/system/cpu/cpu[0-9]*; do
            f="$cpu/cpufreq/scaling_max_freq"
            if [ -f "$f" ]; then
                if [ -w "$f" ]; then
                    echo "$setval" > "$f" || true
                else
                    sudo sh -c "echo $setval > $f" 2>/dev/null || true
                fi
            fi
        done
    fi
fi
write_profile "$PROFILE"
echo "Profile set to $PROFILE"
XUI_HEREDOC_81
        chmod +x "$BIN_DIR/xui_battery_profile.sh"

        # Battery monitor: Python small script that watches capacity and enables saver below threshold
        cat > "$BIN_DIR/xui_battery_monitor.py" <<'XUI_HEREDOC_82'
#!/usr/bin/env python3
import time, os, subprocess, logging
XUI=os.path.expanduser('~/.xui')
logging.basicConfig(filename=os.path.join(XUI,'logs','battery_monitor.log'), level=logging.INFO, format='%(asctime)s %(message)s')
THRESHOLD=int(os.environ.get('XUI_BATTERY_THRESHOLD','20'))
CHECK=int(os.environ.get('XUI_BATTERY_CHECK_SEC','60'))

def read_capacity():
    # try sysfs
    for base in ['/sys/class/power_supply']:
        if os.path.isdir(base):
            for s in os.listdir(base):
                p=os.path.join(base,s,'capacity')
                if os.path.exists(p):
                    try:
                        return int(open(p).read().strip())
                    except Exception:
                        continue
    # fallback to upower
    try:
        out=subprocess.check_output(['upower','-e'], text=True)
        for dev in out.splitlines():
            try:
                info=subprocess.check_output(['upower','-i',dev], text=True)
                for line in info.splitlines():
                    line=line.strip()
                    if line.startswith('percentage:'):
                        return int(line.split()[1].strip('%'))
            except Exception:
                continue
    except Exception:
        pass
    return None

def is_charging():
    for base in ['/sys/class/power_supply']:
        if os.path.isdir(base):
            for s in os.listdir(base):
                p=os.path.join(base,s,'status')
                if os.path.exists(p):
                    try:
                        st=open(p).read().strip().lower()
                        if 'charging' in st:
                            return True
                    except Exception:
                        continue
    try:
        out=subprocess.check_output(['upower','-i',subprocess.check_output(['upower','-e']).splitlines()[0]], text=True)
        for line in out.splitlines():
            if 'state:' in line:
                if 'charging' in line.lower():
                    return True
    except Exception:
        pass
    return False

def enable_saver():
    subprocess.run([os.path.join(XUI,'bin','xui_battery_saver.sh'),'enable'])
def disable_saver():
    subprocess.run([os.path.join(XUI,'bin','xui_battery_saver.sh'),'disable'])

def main():
    saver_on=False
    logging.info('battery monitor started, threshold=%s, check=%s', THRESHOLD, CHECK)
    while True:
        try:
            cap=read_capacity()
            ch=is_charging()
            logging.debug('cap=%s charging=%s saver_on=%s', cap, ch, saver_on)
            if cap is not None:
                if cap<=THRESHOLD and not ch and not saver_on:
                    logging.info('capacity %s <= %s, enabling saver', cap, THRESHOLD)
                    enable_saver(); saver_on=True
                if ch and saver_on:
                    logging.info('charging detected, disabling saver')
                    disable_saver(); saver_on=False
        except Exception as e:
            logging.exception('monitor loop error: %s', e)
        time.sleep(CHECK)

if __name__=='__main__':
    main()
XUI_HEREDOC_82
        chmod +x "$BIN_DIR/xui_battery_monitor.py"

        # Systemd user unit to run monitor
        cat > "$SYSTEMD_USER_DIR/xui-battery-monitor.service" <<'XUI_HEREDOC_83'
[Unit]
Description=XUI Battery Monitor

[Service]
Type=simple
ExecStart=%h/.xui/bin/xui_battery_monitor.py
Restart=on-failure

[Install]
WantedBy=default.target
XUI_HEREDOC_83

}


finish_setup(){
  info "Finalizing installation"
    # make sure everything is executable (only when present)
    if [ -d "$BIN_DIR" ]; then
        chmod -R a+x "$BIN_DIR" || true
    fi
    if [ -f "$DASH_DIR/pyqt_dashboard_improved.py" ]; then
        chmod +x "$DASH_DIR/pyqt_dashboard_improved.py" || true
    fi
    if [ -f "$BIN_DIR/xui_joy_listener.py" ]; then
        chmod +x "$BIN_DIR/xui_joy_listener.py" || true
    fi
  touch "$XUI_DIR/.xui_4_0xv_setup_done"
  info "Installation complete. To enable services run:"
    echo "  systemctl --user daemon-reload && systemctl --user enable --now xui-dashboard.service xui-joy.service"
    # try to enable battery monitor service automatically if systemctl --user available
    if command -v systemctl >/dev/null 2>&1; then
        if systemctl --user daemon-reload >/dev/null 2>&1; then
            systemctl --user enable --now xui-battery-monitor.service || true
            info "Attempted to enable xui-battery-monitor.service (user)"
        fi
    fi
}

main(){
    parse_args "$@"
    info "Starting XUI Ultra Master installer (Kubuntu/Noble target)"
    ensure_dirs
    write_web_control

    # Core asset and dashboard creation
    copy_assets
    generate_placeholders
    copy_all_mp3s
    convert_pngs_to_webp
    write_manifest

    # Dashboard and helpers
    write_dashboard_py
    write_startup_wrapper
    write_volume_brightness_scripts
    write_theme_toggle

    # Utilities and optional components (safe no-op if missing deps)
    write_joy_py
    write_extras
    write_apps_utilities
    write_more_apps
    write_even_more_apps
    write_battery_tools

    # Autostart and systemd user units
    write_systemd_and_autostart
    write_enable_autostart_script

    # Generators, tests and documentation
    write_asset_generator
    post_create_assets
    write_logger_and_helpers
    write_backup_restore
    write_diagnostics
    write_profiles_manager
    write_plugins_skeleton
    write_auto_update
    write_uninstall
    write_readme_and_requirements
    write_basic_tests

    finish_setup

    # On Kubuntu (KDE) we don't prompt in the scripted flow. If user passed --yes-install,
    # start the dashboard now; otherwise print instructions to enable autostart or launch manually.
    if [ "${AUTO_INSTALL_TOOLS:-0}" = "1" ]; then
        info "Auto-install requested: enabling autostart (systemd --user / autostart desktop)"
        if [ -x "$BIN_DIR/xui_enable_autostart.sh" ]; then
            "$BIN_DIR/xui_enable_autostart.sh" || warn "xui_enable_autostart.sh failed"
        fi
        # Try to start the dashboard after enabling autostart
        "$BIN_DIR/xui_start.sh" || true
    else
        info "Installer finished. To start the dashboard now run: $BIN_DIR/xui_start.sh"
        info "To enable autostart (systemd --user) run: $BIN_DIR/xui_enable_autostart.sh"
    fi
}

main "$@"
